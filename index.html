<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è¯›ä»™ä¸¹é’Buildè®¡ç®—å™¨</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root { 
            --primary: #3498db; 
            --bg: #f5f6fa; 
            --dark: #2c3e50; 
            --panel: #ffffff; 
            --gray: #bdc3c7; 
            --card-blue: #3498db; 
            --card-red: #e74c3c;
            --card-green: #27ae60;
        }
        body { font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background: var(--bg); color: var(--dark); margin: 0; padding: 20px; display: flex; justify-content: center; height: 100vh; box-sizing: border-box; overflow: hidden; }
        
        .layout { display: flex; width: 100%; max-width: 1600px; gap: 20px; height: 100%; }
        
        /* --- å·¦ä¾§é¢æ¿ --- */
        .card-list-panel { flex: 0 0 720px; display: flex; flex-direction: column; background: var(--panel); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); overflow: hidden; }
        
        .list-header { 
            padding: 15px 20px; background: #ecf0f1; border-bottom: 1px solid #bdc3c7; 
            display: flex; justify-content: space-between; align-items: center; user-select: none; 
        }
        
        .header-left-group { display: flex; align-items: center; gap: 15px; }
        .header-title { font-weight: bold; font-size: 18px; color: var(--dark); }
        .global-ctrl { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #7f8c8d; }
        
        /* æŒ‰é’®ç»„æ ·å¼ */
        .header-btn-group { display: flex; gap: 10px; }

        .clear-btn { 
            font-size: 12px; cursor: pointer; color: #fff; background: #e74c3c; 
            border: none; padding: 6px 15px; border-radius: 4px; 
            transition: all 0.2s; font-weight: bold;
        }
        .clear-btn:hover { background: #c0392b; box-shadow: 0 2px 5px rgba(231, 76, 60, 0.3); }

        /* é€šç”¨åŠŸèƒ½æŒ‰é’®æ ·å¼ (æ’åº & æ¨¡å¼) */
        .ctrl-btn {
            font-size: 12px; cursor: pointer; color: #fff; background: #3498db; 
            border: none; padding: 6px 15px; border-radius: 4px; 
            transition: all 0.2s; font-weight: bold; min-width: 80px;
        }
        .ctrl-btn:hover { background: #2980b9; box-shadow: 0 2px 5px rgba(52, 152, 219, 0.3); }

        /* å¡ç‰Œæ»šåŠ¨åŒº (3åˆ—) */
        .scroll-area { 
            flex: 1; overflow-y: auto; padding: 15px; 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 12px; 
            align-content: start;
        }
        
        /* å¡ç‰Œå•å…ƒæ ¼ */
        .card-item { 
            background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; 
            cursor: pointer; transition: all 0.1s; user-select: none;
            display: flex; flex-direction: column; justify-content: center;
            height: 72px; 
            padding: 0 12px; position: relative; gap: 8px;
        }
        .card-item:hover { border-color: #bdc3c7; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.08); }
        .card-item.equipped { 
            background: #eef9fe; 
            border-color: #3498db; 
            box-shadow: 0 0 0 1px #3498db inset; 
        }
        
        /* å¡ç‰Œå†…å®¹ */
        .card-meta { display: flex; align-items: center; gap: 6px; }
        .card-name { font-weight: 700; font-size: 15px; color: #333; white-space: nowrap; }
        
        /* è´¹ç”¨æ ‡ç­¾æ ·å¼ï¼šç™½åº•é»‘å­— + ç°è‰²è¾¹æ¡† */
        .card-cost { 
            background: #fff; 
            color: #333; 
            border: 1px solid #bdc3c7; /* åŠ ä¸ªè¾¹æ¡†é˜²æ­¢çœ‹ä¸æ¸… */
            font-size: 11px; padding: 2px 5px; border-radius: 3px; font-weight: bold; min-width: 14px; text-align: center;
        }
    
        .card-type { font-size: 10px; padding: 2px 4px; border-radius: 3px; color: white;}
        .type-human { background-color: var(--card-blue); }
        .type-beast { background-color: var(--card-red); }
        .type-tool { background-color: var(--card-green); }

        /* ç­‰çº§åœ†ç‚¹ */
        .dots-wrapper { display: flex; gap: 6px; align-items: center; }
        .dot { 
            width: 12px; height: 12px; 
            border-radius: 50%; background: #e0e0e0; cursor: pointer; transition: all 0.2s; border: 1px solid transparent; 
        }
        .dot:hover { transform: scale(1.2); border-color: #f1c40f; background: #ccc; }
        .dot.active { background: #f1c40f; box-shadow: 0 0 2px rgba(241, 196, 15, 0.6); }


        /* --- å³ä¾§é¢æ¿ --- */
        .right-panel { flex: 1; display: flex; flex-direction: column; gap: 15px; min-width: 0; }
        
        .detail-card { background: var(--panel); padding: 15px 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); min-height: 80px; }
        .detail-title { font-size: 18px; font-weight: bold; margin-bottom: 5px; color: var(--dark); border-bottom: 2px solid var(--primary); padding-bottom: 5px; display: inline-block;}
        .detail-desc { font-size: 14px; line-height: 1.6; color: #555; }
        .highlight { color: #e74c3c; font-weight: bold; }
        
        /* ä»ªè¡¨ç›˜ */
        .dashboard { flex: 1; background: var(--dark); color: white; border-radius: 12px; padding: 20px; display: flex; flex-direction: column; overflow-y: auto; }
        
        /* è¾“å…¥æ§ä»¶åŒº */
        .controls-area { margin-bottom: 15px; display: flex; flex-direction: column; gap: 10px; }

        /* é€‰é¡¹è¡Œ */
        .options-row { display: flex; gap: 20px; font-size: 12px; color: #bdc3c7; align-items: center; }
        .chk-label { display: flex; align-items: center; gap: 5px; cursor: pointer; user-select: none; }
        .chk-label input { cursor: pointer; }

        /* ç»Ÿä¸€çš„å•è¡Œæ•°æ®æ  */
        .unified-row { 
            display: flex; justify-content: space-between; align-items: center; 
            background: rgba(255,255,255,0.08); padding: 15px 20px; border-radius: 8px; 
            margin-bottom: 5px;
        }

        .left-group { display: flex; gap: 15px; align-items: center; }
        .right-group { display: flex; gap: 30px; align-items: center; border-left: 1px solid rgba(255,255,255,0.1); padding-left: 20px;}

        .inp-item { display: flex; flex-direction: column; gap: 5px; }
        .inp-item label { font-size: 12px; color: #95a5a6; font-weight: bold; white-space: nowrap; }
        .inp-item input { 
            background: rgba(0,0,0,0.3); border: 1px solid #555; color: white; 
            padding: 6px; border-radius: 4px; width: 90px; text-align: center; font-weight: bold; font-size: 14px;
        }
        .inp-item input:focus { border-color: var(--primary); outline: none; background: rgba(0,0,0,0.5); }
        
        /* å»æ‰è¾“å…¥æ¡†çš„ä¸Šä¸‹ç®­å¤´ */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* ç»Ÿè®¡æ•°å€¼æ ·å¼ */
        .stat-box { display: flex; flex-direction: column; align-items: flex-end; }
        .stat-label { font-size: 12px; color: #7f8c8d; margin-bottom: 2px; }
        .stat-val { font-size: 20px; font-weight: bold; line-height: 1.2;}

        /* éšè—ç±» */
        .hidden { display: none !important; }

        /* ä¼¤å®³æ˜ç»†è¡¨ */
        .dps-breakdown { background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-top: 10px; flex: 1; overflow-y: auto; }
        
        .breakdown-header { display: flex; padding: 8px 0; border-bottom: 1px solid #7f8c8d; font-size: 12px; color: #bdc3c7; font-weight: bold; user-select: none; }
        .col-name { flex: 2; padding-left: 5px; }
        .col-freq { flex: 1.2; text-align: center; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px; transition: color 0.2s;}
        .col-freq:hover { color: white; }
        .col-val { flex: 1.5; text-align: right; cursor: pointer; display: flex; align-items: center; justify-content: flex-end; gap: 4px; transition: color 0.2s;}
        .col-val:hover { color: white; }
        .col-pct { flex: 0.8; text-align: right; }
        
        .breakdown-row { display: flex; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 13px; align-items: center; }
        .breakdown-row:last-child { border-bottom: none; }
        .breakdown-row:hover { background: rgba(255,255,255,0.05); }

        /* é¢å¤–æ•ˆæœåŒºåŸŸæ ·å¼ */
        .extra-box {
            background: rgba(255,255,255,0.03);
            border: 1px dashed rgba(255,255,255,0.15);
            border-radius: 8px;
            padding: 10px 15px;
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .extra-title {
            font-size: 12px;
            font-weight: bold;
            color: #f39c12; /* æ©™é»„è‰²æ ‡é¢˜ */
            margin-bottom: 5px;
            opacity: 0.9;
        }
        .extra-row {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #95a5a6;
            padding: 2px 0;
            border-bottom: 1px solid rgba(255,255,255,0.02);
        }
        .extra-row:last-child { border-bottom: none; }
        .extra-name { color: #bdc3c7; }
        .extra-val { color: #ecf0f1; }
        .extra-val .highlight { color: #2ecc71; font-weight: bold; } /* ç»¿è‰²é«˜äº®æ•°å€¼ */

        .footer-info {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.05); /* ææ·¡çš„åˆ†å‰²çº¿ */
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .copyright {
            font-size: 12px;
            color: #7f8c8d;
            font-family: Consolas, Monaco, monospace; /*ç”¨ä»£ç å­—ä½“æ˜¾å¾—æ¯”è¾ƒæå®¢*/
        }

        .visit-stats {
            font-size: 10px; /* å­—ä½“éå¸¸å°ï¼Œä¸çªå…€ */
            color: #555;     /* é¢œè‰²å¾ˆæš—ï¼Œåªæœ‰ä»”ç»†çœ‹æ‰çœ‹å¾—åˆ° */
        }
        
        /* ç§»åŠ¨ç«¯é€‚é…ä¿®æ­£ï¼šé˜²æ­¢é¡µè„šè¢«æŒ¤å‡ºå» */
        @media screen and (max-width: 1024px) {
            .footer-info {
                margin-bottom: 30px; /* æ‰‹æœºä¸Šç»™åº•éƒ¨ç•™ç‚¹ç©ºé—´ */
            }
        }

        /* æœ€ç»ˆç»“æœæ  */
        .final-result { 
            margin-top: auto; padding-top: 20px; 
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; 
        }
        .res-card { 
            background: rgba(255,255,255,0.08); border-radius: 8px; padding: 10px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .res-card-label { font-size: 12px; color: #bdc3c7; margin-bottom: 5px; }
        .res-card-val { font-size: 22px; font-weight: bold; }
        
        .c-total { color: #f1c40f; }
        .c-system { color: #3498db; }
        .c-inc { color: #2ecc71; }
        
        .sort-arrow { font-size: 10px; opacity: 0.5; }

        /* =========================================
           ç§»åŠ¨ç«¯é€‚é… (å“åº”å¼å¸ƒå±€) - æœ€ç»ˆä¿®æ­£ç‰ˆ
           ========================================= */
        @media screen and (max-width: 1024px) {
            body {
                height: auto;
                overflow-y: auto; 
                -webkit-overflow-scrolling: touch; /* é¡ºæ»‘æ»šåŠ¨ */
            }

            .layout {
                flex-direction: column;
                height: auto;
            }

            /* --- å·¦ä¾§é¢æ¿ --- */
            .card-list-panel {
                flex: none;
                width: 100%;
                /* è¿™é‡Œè®¾ä¸º autoï¼Œé«˜åº¦ç”±å†…éƒ¨çš„ scroll-area æ’‘å¼€ */
                height: auto; 
                max-height: none; 
                margin-bottom: 0px;
            }

            .list-header {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
                height: auto;
                padding: 15px;
            }

            .header-left-group { width: 100%; justify-content: space-between; }
            .header-btn-group { width: 100%; display: flex; gap: 10px; }
            .ctrl-btn, .clear-btn { flex: 1; text-align: center; padding: 8px 0; }

            /* ã€å…³é”®ä¿®æ­£ã€‘å¡ç‰Œåˆ—è¡¨å®¹å™¨ */
            .scroll-area {
                /* 1. å¼ºåˆ¶å–æ¶ˆ flex è‡ªé€‚åº”ï¼Œå¦åˆ™ height ä¸ç”Ÿæ•ˆ */
                flex: none !important;
                
                /* 2. è®¾å®šå›ºå®šé«˜åº¦ï¼šå¡ç‰‡72+é—´è·12=84ï¼Œ84*5=420ï¼ŒåŠ paddingå‡‘450 */
                height: 370px !important; 
                
                /* 3. å¼ºåˆ¶å¼€å¯ Y è½´æ»šåŠ¨ */
                overflow-y: auto !important;
                
                /* 4. ä¸¤åˆ—å¸ƒå±€ */
                grid-template-columns: repeat(2, 1fr); 
                
                /* è§†è§‰ä¼˜åŒ–ï¼šç»™ä¸ªè¾¹æ¡†è®©äººçŸ¥é“è¿™é‡Œèƒ½æ»‘ */
                border-top: 1px solid #eee;
                border-bottom: 1px solid #eee;
            }

            /* --- å³ä¾§é¢æ¿ --- */
            .right-panel { width: 100%; flex: none; }

            .unified-row {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }

            /* è¾“å…¥æ¡† 2x2 æ’åˆ— */
            .left-group {
                width: 100%;
                justify-content: space-between;
                border-left: none;
                padding-left: 0;
                flex-wrap: wrap; 
                gap: 10px; 
            }
            .inp-item { width: 48%; }
            .inp-item input { width: 100%; box-sizing: border-box; }
            
            .right-group {
                width: 100%;
                justify-content: space-between;
                border-top: 1px solid rgba(255,255,255,0.1);
                padding-top: 15px;
            }

            .final-result { grid-template-columns: 1fr; gap: 10px; }
            .stat-val { font-size: 18px; }
            .card-item { height: auto; padding: 10px; }
            .footer-info { margin-bottom: 30px; }
            .copyright { gap: 5px; }
        }
        
    </style>
</head>
<body>

<div class="layout">
    <div class="card-list-panel">
        <div class="list-header">
            <div class="header-left-group">
                <span class="header-title">ä¸¹é’é…ç½®</span>
                <div class="global-ctrl">
                    <span>ä¸€é”®è°ƒæ•´:</span>
                    <div class="dots-wrapper" id="global-dots"></div>
                </div>
            </div>
            
            <div class="header-btn-group">
                <button class="ctrl-btn" id="sortBtn" onclick="toggleSortMode()">æ’åº: æŒ‰ç±»åˆ«</button>
                <button class="ctrl-btn" id="modeBtn" onclick="toggleClickMode()">æ¨¡å¼: åŒå‡»è£…å¤‡</button>
                <button class="clear-btn" onclick="clearAll()">æ¸…ç©ºé€‰æ‹©</button>
            </div>
        </div>
        
        <div class="scroll-area" id="cardList"></div>
    </div>

    <div class="right-panel">
        
        <div class="detail-card">
            <div id="detail-content">
                <div style="color: #ccc; padding-top: 15px; text-align: center;">å•å‡»å¡ç‰ŒæŸ¥çœ‹è¯¦æƒ… / åŒå‡»è£…å¤‡æˆ–å¸ä¸‹</div>
            </div>
        </div>

        <div class="dashboard">
            <div class="controls-area">
                <div class="options-row">
                    <label class="chk-label">
                        <input type="checkbox" id="chk-showFlat" onchange="calc()" checked> 
                        ç‹¬ç«‹æ˜¾ç¤ºä¸¹é’ç™½å­—æ”»å‡»æå‡å æ¯”
                    </label>
                    <label class="chk-label">
                        <input type="checkbox" id="chk-dilution" onchange="toggleDilution()"> 
                        è€ƒè™‘å…¶ä»–æ”»å‡»åŠ›æå‡ç¨€é‡Š
                    </label>
                </div>

                <div class="unified-row">
                    <div class="left-group">
                        <div class="inp-item">
                            <label>ç©å®¶æ”»å‡»åŠ›</label>
                            <input type="number" id="baseAtk" value="10000" oninput="calc()">
                        </div>
                        <div class="inp-item">
                            <label>å›ºæœ‰DPS</label>
                            <input type="number" id="baseDps" value="50000" oninput="calc()">
                        </div>
                        
                        <div class="inp-item hidden" id="dilution-pct-box">
                            <label style="color:#e67e22">å…¶ä»–æ”»å‡»(%)</label>
                            <input type="number" id="extraPct" value="4" oninput="calc()" style="border-color:#e67e22">
                        </div>
                        <div class="inp-item hidden" id="dilution-flat-box">
                            <label style="color:#e67e22">å…¶ä»–ç™½å­—</label>
                            <input type="number" id="extraFlat" value="0" oninput="calc()" style="border-color:#e67e22">
                        </div>
                    </div>

                    <div class="right-group">
                        <div class="stat-box">
                            <div class="stat-label">æ€» Cost èŠ±è´¹</div>
                            <div class="stat-val" style="color:#f1c40f;"><span id="currCost">0</span></div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">ä¸¹é’ç™½å­—æ”»å‡»</div>
                            <div class="stat-val" style="color:#3498db;" id="res-flatAtk">0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">æœ€ç»ˆæ”»å‡»åŠ›</div>
                            <div class="stat-val" style="color:#fff;" id="res-finalAtk">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="font-size:12px; color:#95a5a6;">ä¼¤å®³æ„æˆåˆ†æ</div>
            </div>
            
            <div class="dps-breakdown">
                <div class="breakdown-header">
                    <div class="col-name">ä¼¤å®³æ¥æº</div>
                    
                    <div class="col-freq" onclick="toggleFreqMode()">
                        <span id="header-freq-text">è§¦å‘é—´éš”</span>
                        <span style="font-size:10px;">â‡„</span>
                    </div>

                    <div class="col-val" onclick="toggleSort()">
                        <span>ç§’ä¼¤ (DPS)</span>
                        <span class="sort-arrow" id="sort-arrow">â–¼</span>
                    </div>
                    
                    <div class="col-pct">å æ¯”</div>
                </div>
                <div id="dps-list">
                    </div>
            </div>

            <div id="extra-effects-box" class="extra-box hidden">
                <div class="extra-title">ğŸ›¡ï¸ å…¶å®ƒç”Ÿæ•ˆå±æ€§ (ä¸è®¡å…¥DPS)</div>
                <div id="extra-list-content"></div>
            </div>

            <div class="final-result">
                <div class="res-card">
                    <div class="res-card-label">æ€»ç§’ä¼¤ (Total)</div>
                    <div class="res-card-val c-total" id="res-totalDps">0</div>
                </div>

                <div class="res-card">
                    <div class="res-card-label">ä¸¹é’æä¾›ç§’ä¼¤</div>
                    <div class="res-card-val c-system" id="res-cardSystemDps">0</div>
                </div>

                <div class="res-card">
                    <div class="res-card-label">ä¸¹é’æä¾›å¢å¹…</div>
                    <div class="res-card-val c-inc" id="res-percent">+0.0%</div>
                </div>
            </div>

            <div class="footer-info">
                <div class="copyright">
                    <span class="credit-item">åˆ¶ä½œ: <span class="author">é±¼å¤•@ä¸€å‰‘è¯›ä»™</span></span>
                    <span class="divider">|</span>
                    <span class="credit-item">æ•°æ®: <span class="author">é€é¥å­@æ˜Ÿæ²³å…¥æ¢¦</span></span>
                </div>
                
                <div class="visit-stats">
                    <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" 
                            onerror="console.log('ä¸è’œå­ç»Ÿè®¡åŠ è½½å¤±è´¥ï¼Œå¯èƒ½æ˜¯è¢«å¹¿å‘Šæ’ä»¶æ‹¦æˆªæˆ–æœåŠ¡ä¸ç¨³å®š');"></script>
                    
                    <span id="busuanzi_container_site_pv"> 
                        Total Views: <span id="busuanzi_value_site_pv" style="color:#2ecc71">--</span>
                        <span style="margin:0 5px; opacity:0.3">|</span>
                        Visitors: <span id="busuanzi_value_site_uv" style="color:#3498db">--</span>
                    </span>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // ==========================================
    // 1. æ•°æ®å®šä¹‰
    // ==========================================
    const Linear = (v0, v6) => ({ type: 'linear', v0, v6 });
    const Fixed = (v) => ({ type: 'fixed', val: v });

    const FLAT_ATK_V0 = 44.9;
    const FLAT_ATK_V6 = 58.2;

    const DB = [
        // --- äººæ— ---
        { id: 'xiaohuan', name: 'å°ç¯', type: 'human', cost: 1, desc: 'ä¼šå¿ƒæé«˜{val}', stat: Linear(280, 400), effect: 'crit_flat' },
        { id: 'wilddog', name: 'é‡ç‹—é“äºº', type: 'human', cost: 1, desc: 'åŒ–ä¼¤å’Œç§½ç­æé«˜{val}', stat: Linear(56, 80), effect: 'none' },
        { id: 'yanhong', name: 'ç‡•è™¹', type: 'human', cost: 1, desc: 'é‡Šæ”¾æŠ€èƒ½æ—¶ï¼Œå‘ç›®æ ‡å‘å°„ä¸€æšå†°ç®­ï¼Œé€ æˆ{val}%å›ºå®šä¼¤å®³ï¼ˆ6ç§’å†·å´ï¼‰', stat: Linear(28, 40), effect: 'ice_base' },
        { id: 'zhou', name: 'å‘¨ä¸€ä»™', type: 'human', cost: 2, desc: 'æ¯è£…å¤‡ä¸€å¼ äººæ—å¡ç‰Œï¼Œç‰©ç†å’Œæ³•æœ¯æ”»å‡»åŠ›æé«˜{val}%', stat: Linear(0.56, 0.80), effect: 'count_race_atk' },
        { id: 'wenmin', name: 'æ–‡æ•', type: 'human', cost: 2, desc: 'æˆ˜æ–—ä¸­æ¯é—´éš”{freq}ç§’ï¼Œå‘ç›®æ ‡å‘å°„3æšå†°ç®­', stat: {v0: 16, v6: 10}, effect: 'ice_add_freq' },
        { id: 'shangguan', name: 'ä¸Šå®˜ç­–', type: 'human', cost: 2, desc: 'å†°ç®­æœ‰{val}%æ¦‚ç‡èµ‹äºˆç›®æ ‡1å±‚ç‡ƒçƒ§', stat: Linear(38, 50), effect: 'ice_trigger_burn' },
        { id: 'linfeng', name: 'æ—å³°', type: 'human', cost: 3, desc: 'é™„åŠ ç‡ƒçƒ§æ•ˆæœæ—¶æœ‰{val}%æ¦‚ç‡é¢å¤–å åŠ 1å±‚ç‡ƒçƒ§ï¼Œå¬å”¤å†°ç®­æ—¶æœ‰{ice}%æ¦‚ç‡é¢å¤–å¬å”¤ä¸€æšå†°ç®­', stat: Linear(42, 60), effect: 'linfeng_dual' },
        { id: 'zuogui', name: 'å·¦å½’', type: 'human', cost: 4, desc: 'å†°ç®­/ç„å†°é£æš´/ç‡ƒçƒ§/è„‰å†²é€ æˆçš„ä¼¤å®³å’Œæ°”è¡€æ¢å¤æ•ˆæœæé«˜{val}%', stat: Linear(28, 40), effect: 'global_dmg_mult' },
        { id: 'qihao', name: 'é½æ˜Š', type: 'human', cost: 5, desc: 'å¬å”¤ä¸€åªå†°éœœå…ƒç´ ï¼Œå‘ç›®æ ‡å‘å°„ç„å†°é£æš´ï¼Œé€ æˆ{val}%å›ºå®šä¼¤å®³ï¼Œæ¯é—´éš”60ç§’ä»…å¯è§¦å‘ä¸€æ¬¡ï¼›æ¯å¬å”¤ä¸€æšå†°ç®­ï¼Œå†°éœœå…ƒç´ çš„å†·å´æ—¶é—´ç¼©çŸ­1ç§’', stat: Linear(1040, 1400), effect: 'qihao_nuke' },

        // --- å…½æ— ---
        { id: 'turtle', name: 'æµ·é¾Ÿ', type: 'beast', cost: 1, desc: 'ä¸“ç²¾æé«˜{val}', stat: Linear(280, 400), effect: 'mastery_flat' },
        { id: 'redant', name: 'çŒ©çº¢å·¨èš', type: 'beast', cost: 1, desc: 'é€ æˆä¼¤å®³æ—¶ï¼Œå¼•ç‡ƒç›®æ ‡å’Œç›®æ ‡å‘¨å›´çš„æ‰€æœ‰æ•Œäººï¼Œæ·»åŠ ç‡ƒçƒ§ï¼Œæ¯3ç§’é€ æˆ{val}%å›ºå®šä¼¤å®³ï¼ŒæŒç»­18ç§’ï¼Œç‡ƒçƒ§æœ€å¤šå¯ä»¥å åŠ 12å±‚ï¼ˆ8ç§’å†…ç½®å†·å´ï¼‰', stat: Linear(1.4, 2), effect: 'burn_base' },
        { id: 'tiger', name: 'çŒ›è™', type: 'beast', cost: 2, desc: 'æ¯è£…å¤‡ä¸€å¼ å…½æ—å¡ç‰Œï¼Œç‰©ç†å’Œæ³•æœ¯æ”»å‡»åŠ›æé«˜{val}%', stat: Linear(0.56, 0.80), effect: 'count_race_atk' },
        { id: 'twotail', name: 'äºŒå°¾å¦–ç‹', type: 'beast', cost: 2, desc: 'å½“è‡ªèº«å°è¯•ä¸ºç›®æ ‡æ·»åŠ ç‡ƒçƒ§æ—¶ï¼Œç«‹åˆ»å¯¹ç›®æ ‡é€ æˆ{val}%ä¼¤å®³', stat: Linear(28, 40), effect: 'burn_on_hit' },
        { id: 'ghostdog', name: 'å¹½å†¥çŠ¬', type: 'beast', cost: 2, desc: 'å—åˆ°ä¼¤å®³æ—¶ä¼šå¼•ç‡ƒå‘¨å›´çš„æ•Œäººï¼Œå¯¹å‘¨å›´çš„æ‰€æœ‰æ•Œäººæ·»åŠ 1å±‚ç‡ƒçƒ§ï¼ˆ{val}ç§’å†…ç½®å†·å´ï¼‰', stat: Linear(10, 4), effect: 'none' },
        { id: 'threetail', name: 'ä¸‰å°¾å¦–ç‹', type: 'beast', cost: 4, desc: 'æ¯ä¸ªæ¿€æ´»çš„ç‡ƒçƒ§ä½¿è‡ªèº«é˜²å¾¡åŠ›æé«˜{val}', stat: Linear(140, 200), effect: 'none' },
        { id: 'suishou', name: 'å²å…½', type: 'beast', cost: 3, desc: 'è„‰å†²å‘½ä¸­æ•Œäººæ—¶ï¼Œæœ‰{val}%æ¦‚ç‡ä¸ºå…¶æ·»åŠ 3å±‚ç‡ƒçƒ§æ•ˆæœ', stat: Linear(70, 100), effect: 'pulse_trigger_burn' },
        { id: 'snowbear', name: 'é›ªåœ°ç†Š', type: 'beast', cost: 4, desc: 'å¬å”¤å†°ç®­æ—¶ï¼Œé€ æˆçš„ä¼¤å®³é¢å¤–æé«˜{val}%ï¼ŒæŒç»­10ç§’ï¼Œå¯å¤šæ¬¡å åŠ ï¼Œæ¯å±‚æ•ˆæœç‹¬ç«‹è®¡ç®—æŒç»­æ—¶é—´', stat: Linear(0.38, 0.5), effect: 'snowbear_buff' },
        { id: 'sixtail', name: 'å…­å°¾é­”ç‹', type: 'beast', cost: 5, desc: 'ç‡ƒçƒ§å åŠ è‡³8å±‚ä»¥ä¸Šæ—¶ï¼Œè§¦å‘çˆ†ç‡ƒï¼š1.5ç§’åï¼Œå¼•çˆ†ç›®æ ‡èº«ä¸Šæ‰€æœ‰çš„ç‡ƒçƒ§æ•ˆæœï¼Œæ¯å¼•çˆ†1å±‚ç‡ƒçƒ§æ•ˆæœï¼Œå¯¹ç›®æ ‡å’Œç›®æ ‡å‘¨å›´çš„æ•Œäººé€ æˆ{val}%ä¼¤å®³', stat: Linear(50, 68), effect: 'sixtail_explode' },

        // --- å™¨æ— ---
        { id: 'woodsword', name: 'æœ¨å‰‘', type: 'tool', cost: 1, desc: 'ä¸»å±æ€§æé«˜{val}%', stat: Linear(0.56, 0.80), effect: 'fixed_atk' },
        { id: 'kite', name: 'é£ç­', type: 'tool', cost: 1, desc: 'è°ƒæ¯æé«˜{val}', stat: Linear(280, 400), effect: 'haste_flat' },
        { id: 'fan', name: 'æŠ˜æ‰‡', type: 'tool', cost: 1, desc: 'æˆ˜æ–—æ¯ç»è¿‡15ç§’ï¼Œè§¦å‘è„‰å†²ï¼Œå¯¹å‘¨å›´æ•Œäººé€ æˆ{val}%ä¼¤å®³ï¼Œä¸ºå‘¨å›´æœ€å¤š10åé˜Ÿå‹é€ æˆ{heal}%æ²»ç–—ã€‚', stat: Linear(40, 52), effect: 'pulse_base' },
        { id: 'banner', name: 'â€œä»™äººâ€å¸ƒå¹¡', type: 'tool', cost: 2, desc: 'æ¯è£…å¤‡ä¸€å¼ å™¨ç‰©å¡ç‰Œï¼Œç‰©ç†å’Œæ³•æœ¯æ”»å‡»åŠ›æé«˜{val}%', stat: Linear(0.56, 0.80), effect: 'count_race_atk' },
        { id: 'dice', name: 'ç¥æœ¨éª°', type: 'tool', cost: 2, desc: 'è„‰å†²é€ æˆä¼¤å®³æˆ–æ°”è¡€æ¢å¤æ•ˆæœæ—¶ï¼Œåœ¨10ç§’å†…é¢å¤–é€ æˆ{val}%ä¼¤å®³æˆ–{heal}%æ°”è¡€æ¢å¤ï¼Œè¿›å…¥æˆ˜æ–—æ—¶ç«‹åˆ»è§¦å‘3æ¬¡è„‰å†²ã€‚', stat: Fixed(70), effect: 'dice_buff' },
        { id: 'bamboo', name: 'å¯’å†°å‰‘', type: 'tool', cost: 3, desc: 'å¬å”¤{freq}æšå†°ç®­åï¼Œè§¦å‘è„‰å†²', stat: {v0: 16, v6: 10}, effect: 'ice_count_pulse' },
        { id: 'pearl', name: 'æ¸…å‡‰ç ', type: 'tool', cost: 3, desc: 'è§¦å‘è„‰å†²æ—¶ï¼Œè‡ªèº«æ°”è¡€æ¢å¤æ•ˆæœæé«˜{val}%ï¼ŒæŒç»­10ç§’ã€‚', stat: Linear(2.8, 4), effect: 'none' },
        { id: 'hehuanbell', name: 'åˆæ¬¢é“ƒ', type: 'tool', cost: 4, desc: 'å—åˆ°ä¼¤å®³æ—¶ï¼Œæ¢å¤{val}%æ”»å‡»åŠ›çš„æ°”è¡€ã€‚æ¥ä¸‹æ¥å—åˆ°40%ä¼¤å®³ã€‚\næ°”è¡€ä½äº30%æ—¶ï¼Œå—åˆ°ä¼¤å®³ç«‹åˆ»æ¢å¤è‡ªèº«63193æ°”è¡€ï¼Œä½†æ¥ä¸‹æ¥çš„10ç§’å†…ï¼Œè‡ªèº«æ€»è®¡å—åˆ°3718ä¼¤å®³ï¼Œæ­¤æ•ˆæœæœ‰120ç§’å†·å´ã€‚', stat: Linear(680, 800), effect: 'none' },
        { id: 'mirror', name: 'å…­åˆé•œ', type: 'tool', cost: 5, desc: 'è§¦å‘è„‰å†²æ—¶ï¼Œæœ‰50%æ¦‚ç‡ä½¿è‡ªèº«è·å¾—å›å“æ•ˆæœï¼ŒæŒç»­6ç§’ã€‚å›å“ï¼šæ¯1ç§’ä»¥{val}%æ•ˆç‡é‡Šæ”¾è„‰å†²ï¼ˆè§¦å‘4æ¬¡{val}%ä¼¤å®³çš„è„‰å†²ï¼‰ï¼Œå›å“æ•ˆæœé‡Šæ”¾çš„è„‰å†²æ— æ³•é™„åŠ è„‰å†²é€ æˆçš„é¢å¤–æ•ˆæœ', stat: Linear(140, 200), effect: 'mirror_echo' },
    ];

    const state = {};
    DB.forEach(c => state[c.id] = { equipped: false, level: 0 });

    // UI State
    let dpsSortDir = 'desc'; 
    let freqMode = 'interval'; 
    let globalLvState = 0;
    
    // ç‚¹å‡»æ¨¡å¼ä¸æ’åºæ¨¡å¼
    let isFastMode = false;
    let cardSortMode = 'type'; // 'type' | 'cost'

    // ==========================================
    // 2. é€»è¾‘è®¡ç®—
    // ==========================================

    function getStatVal(cardId) {
        const card = DB.find(c => c.id === cardId);
        const lv = state[cardId].level;
        const s = card.stat;
        if (s.type === 'fixed') return s.val;
        const range = s.v6 - s.v0;
        return s.v0 + range * (lv / 6);
    }
    
    function getCardFlatAtk(cardId) {
        const c = DB.find(x => x.id === cardId);
        const lv = state[cardId].level;
        const range = FLAT_ATK_V6 - FLAT_ATK_V0;
        const baseFlat = FLAT_ATK_V0 + range * (lv / 6);
        return baseFlat * c.cost;
    }

    const isEq = (id) => state[id].equipped;

    function toggleDilution() {
        const checked = document.getElementById('chk-dilution').checked;
        const box1 = document.getElementById('dilution-pct-box');
        const box2 = document.getElementById('dilution-flat-box');
        if (checked) {
            box1.classList.remove('hidden');
            box2.classList.remove('hidden');
        } else {
            box1.classList.add('hidden');
            box2.classList.add('hidden');
        }
        calc();
    }



// å…¨å±€å˜é‡
    let g_finalAtk = 0;

    function calc() {
        // --- 0. åŸºç¡€è¾“å…¥ä¸é€‰é¡¹è¯»å– ---
        const userInputAtk = parseFloat(document.getElementById('baseAtk').value) || 0;
        const userBaseDps = parseFloat(document.getElementById('baseDps').value) || 0;
        
        const showFlatBreakdown = document.getElementById('chk-showFlat').checked;
        const useDilution = document.getElementById('chk-dilution').checked;

        let extraPct = 0; 
        let extraFlat = 0; 

        if (useDilution) {
            extraPct = parseFloat(document.getElementById('extraPct').value) || 0;
            extraFlat = parseFloat(document.getElementById('extraFlat').value) || 0;
        }

        // --- 1. ç»Ÿè®¡å¡ç‰Œæ•°æ® ---
        let countHuman = 0, countBeast = 0, countTool = 0;
        let costSum = 0;
        let cardTotalFlatAtk = 0; 

        DB.forEach(c => {
            if (isEq(c.id)) {
                costSum += c.cost;
                if (c.type === 'human') countHuman++;
                if (c.type === 'beast') countBeast++;
                if (c.type === 'tool') countTool++;
                cardTotalFlatAtk += getCardFlatAtk(c.id);
            }
        });

        // ä¸¹é’æä¾›çš„æ”»å‡»åŠ›ç™¾åˆ†æ¯”
        let cardAtkPct = 0;
        if (isEq('zhou')) cardAtkPct += getStatVal('zhou') * countHuman;
        if (isEq('tiger')) cardAtkPct += getStatVal('tiger') * countBeast;
        if (isEq('banner')) cardAtkPct += getStatVal('banner') * countTool;
        if (isEq('woodsword')) cardAtkPct += getStatVal('woodsword');

        // --- 2. æ ¸å¿ƒæ•°å€¼è®¡ç®— ---
        const totalPct = extraPct + cardAtkPct; 
        const realBaseAtk = userInputAtk + extraFlat + cardTotalFlatAtk; 
        const finalAtk = realBaseAtk * (1 + totalPct/100); 

        // æ›´æ–°å…¨å±€å˜é‡
        g_finalAtk = finalAtk;

        // --- 3. ä¸¹é’ç‰¹æ•ˆå‚æ•°è®¡ç®— ---
        
        // ã€æ–°å¢é€»è¾‘ã€‘åŸºç¡€æŠ€èƒ½ç³»æ•°è®¡ç®— helper
        // å¦‚æœè£…å¤‡äº†ï¼Œå–å½“å‰ç­‰çº§ï¼›æ²¡è£…å¤‡ï¼Œå– -1 çº§
        const getDmgRatio = (id) => {
            if (isEq(id)) return getStatVal(id); // å·²è£…å¤‡ï¼šç”¨å½“å‰ç­‰çº§
            
            // æœªè£…å¤‡ï¼šè®¡ç®— -1 çº§æ•°å€¼
            const c = DB.find(x => x.id === id);
            const s = c.stat;
            if (s.type === 'fixed') return s.val;
            // çº¿æ€§å…¬å¼: v0 + (step * lv)
            // step = (v6 - v0) / 6
            // lv = -1
            return s.v0 + (s.v6 - s.v0) * (-1 / 6);
        };

        const ratios = {
            // è¿™ä¸‰ä¸ªä½¿ç”¨æ–°çš„ -1 çº§ä¿åº•é€»è¾‘
            ice: getDmgRatio('yanhong'), 
            burn: getDmgRatio('redant'), 
            pulse: getDmgRatio('fan'),
            
            // å…¶ä»–ä¸“å±æŠ€èƒ½ä¸éœ€è¦ä¿åº•ï¼ˆæ²¡è£…å¤‡é€šå¸¸å°±æ²¡æœ‰è¯¥ç‰¹æ•ˆï¼‰
            qihao: getStatVal('qihao'), 
            foxExplode: getStatVal('sixtail'), 
            ignite: getStatVal('twotail'),
            mirror: getStatVal('mirror'), 
            dice: getStatVal('dice'), 
            suishouChance: getStatVal('suishou'),
            snowbear: getStatVal('snowbear')
        };

        // å·¦å½’å¢ä¼¤
        let zuoguiMult = 1.0; 
        if (isEq('zuogui')) zuoguiMult += (getStatVal('zuogui') / 100);

        // æ—å³° & é¢‘ç‡
        let linfengIceChance = 0, linfengBurnChance = 0;
        if (isEq('linfeng')) {
            linfengBurnChance = getStatVal('linfeng') / 100;
            linfengIceChance = 0.7 + ((1.0 - 0.7)/6 * state['linfeng'].level);
        }

        let rawIceRate = 0; 
        if (isEq('yanhong')) rawIceRate += (1/6);
        if (isEq('wenmin')) rawIceRate += (3 / getStatVal('wenmin'));
        let finalIceRate = rawIceRate * (1 + linfengIceChance);

        // é›ªåœ°ç†Š: å…¨å±€å¢ä¼¤
        let snowbearMult = 1.0;
        let snowbearLabel = '';
        if (isEq('snowbear') && finalIceRate > 0) {
            const avgStacks = finalIceRate * 10;
            const boostPerStack = ratios.snowbear; 
            const totalBoostPct = avgStacks * boostPerStack;
            snowbearMult = 1 + (totalBoostPct / 100);
            snowbearLabel = ` é›ªåœ°ç†Šå…¨å±€å¢ä¼¤ (å‡${avgStacks.toFixed(1)}å±‚)`;
        }

        let pulseRate = 0;
        if (isEq('fan')) pulseRate += (1/15);
        if (isEq('bamboo') && finalIceRate > 0) pulseRate += (finalIceRate / getStatVal('bamboo'));
        let pulseHitRate = pulseRate; 

        let eventRedant = isEq('redant') ? (1/8) : 0;
        let eventShangguan = isEq('shangguan') ? (finalIceRate * getStatVal('shangguan')/100) : 0;
        let eventSuishou = 0;
        if (isEq('suishou')) eventSuishou = (pulseHitRate * (ratios.suishouChance / 100)) * 3;
        
        let totalIgniteTriggers = (eventRedant + eventShangguan + eventSuishou) * (1 + linfengBurnChance);
        let finalStackRate = totalIgniteTriggers; 

        // --- 4. ä¼¤å®³è®¡ç®— ---
        let explodeFreq = 0;
        let explodeStacks = 0; 
        if (isEq('sixtail') && finalStackRate > 0) {
            const timeTo8 = 8 / finalStackRate;
            const extraStacks = finalStackRate * 1.5;
            explodeStacks = Math.min(12, 8 + extraStacks);
            const cycleTime = timeTo8 + 1.5;
            explodeFreq = 1 / cycleTime;
        }

        // å¹³ç 
        let fullSwingDps = userInputAtk > 0 ? (userBaseDps * finalAtk / userInputAtk * snowbearMult) : 0;

        let skillBreakdown = { ice:0, pulse:0, burn:0, ignite:0, explode:0, qihao:0 };
        let fullSkillDps = 0;

        // å†°ç®­ (äº«å—å·¦å½’)
        if (finalIceRate > 0) {
            skillBreakdown.ice = finalAtk * (ratios.ice / 100) * snowbearMult * zuoguiMult * finalIceRate;
            fullSkillDps += skillBreakdown.ice;
        }
        
        // è„‰å†² (äº«å—å·¦å½’)
        if (pulseHitRate > 0) {
            let val = finalAtk * ((ratios.pulse + (isEq('dice')?ratios.dice:0)) / 100) * snowbearMult * zuoguiMult * pulseHitRate;
            if (isEq('mirror')) val += finalAtk * (ratios.mirror / 100) * snowbearMult * zuoguiMult * pulseHitRate * 0.5 * 4;
            skillBreakdown.pulse = val;
            fullSkillDps += val;
        }
        
        // ç‡ƒçƒ§DOT (äº«å—å·¦å½’)
        if (finalStackRate > 0) {
            let avgStacks = 12;
            let labelSuffix = '(12å±‚)';
            if (isEq('sixtail')) {
                avgStacks = explodeStacks * 0.55; 
                labelSuffix = `(åŠ¨æ€å‡å€¼${avgStacks.toFixed(1)}å±‚)`;
            }
            let val = finalAtk * (ratios.burn / 100) * avgStacks * snowbearMult * zuoguiMult * (1/3);
            skillBreakdown.burn = val;
            fullSkillDps += val;
            skillBreakdown._burnLabel = ' ç‡ƒçƒ§ DOT ' + labelSuffix;
            
            // çˆ†ç‡ƒ (å…­å°¾) -> ä¸äº«å—å·¦å½’
            if (isEq('sixtail')) {
                let exVal = finalAtk * (ratios.foxExplode / 100) * explodeStacks * snowbearMult * explodeFreq;
                skillBreakdown.explode = exVal;
                fullSkillDps += exVal;
                skillBreakdown._explodeLabel = ` å…­å°¾å¦–ç‹-çˆ†ç‡ƒ (æ¯æ¬¡${explodeStacks.toFixed(1)}å±‚)`;
            }
        }
        
        // å¼•ç‡ƒ (äºŒå°¾) -> ä¸äº«å—å·¦å½’
        if (isEq('twotail')) {
            let val = finalAtk * (ratios.ignite / 100) * snowbearMult * totalIgniteTriggers;
            skillBreakdown.ignite = val;
            fullSkillDps += val;
        }
        
        // ç„å†°é£æš´ (é½æ˜Š) -> äº«å—å·¦å½’
        if (isEq('qihao')) {
            let qFreq = 1 / (60 / (1 + finalIceRate));
            let val = finalAtk * (ratios.qihao / 100) * snowbearMult * zuoguiMult * qFreq;
            skillBreakdown.qihao = val;
            fullSkillDps += val;
        }

        let currentTotalDps = fullSwingDps + fullSkillDps; 

        // --- 5. ä¼¤å®³æ‹†è§£ ---
        let val_snowbear = 0;
        let val_flat = 0;
        let val_buff = 0;
        let val_base = 0;

        // A. å‰¥ç¦»é›ªåœ°ç†Š
        if (snowbearMult > 1.0) {
            val_snowbear = currentTotalDps * (1 - 1/snowbearMult);
            fullSwingDps /= snowbearMult;
            for (let k in skillBreakdown) {
                if(!k.startsWith('_')) skillBreakdown[k] /= snowbearMult;
            }
        }
        let dpsWithoutSnow = currentTotalDps - val_snowbear;

        // B. å‰¥ç¦»ç™½å­—
        const flatRatio = finalAtk > 0 ? (cardTotalFlatAtk * (1 + totalPct/100) / finalAtk) : 0;
        if (showFlatBreakdown && flatRatio > 0) {
            val_flat = dpsWithoutSnow * flatRatio;
            fullSwingDps *= (1 - flatRatio);
            for (let k in skillBreakdown) {
                if(!k.startsWith('_')) skillBreakdown[k] *= (1 - flatRatio);
            }
        }

        // C. å‰¥ç¦»æ”»å‡»ç™¾åˆ†æ¯”
        let buffLabel = ' æ”»å‡»åŠ›ç™¾åˆ†æ¯”æ”¶ç›Š';
        if (cardAtkPct > 0) {
            val_buff = fullSwingDps * (1 - (1 + extraPct/100)/(1 + totalPct/100));
            
            const absAtkGain = realBaseAtk * (cardAtkPct / 100);
            buffLabel = ` æ”»å‡»åŠ›ç™¾åˆ†æ¯”æ”¶ç›Š (â†‘${cardAtkPct.toFixed(1)}% / <span style="color:#f1c40f">+${Math.round(absAtkGain)}</span>)`;
        }

        val_base = fullSwingDps - val_buff;

        // --- 6. ç»„è£… ---
        let breakdownList = [];
        let baseLabel = useDilution ? ' ç©å®¶å›ºæœ‰ (å«ç¨€é‡Š)' : ' ç©å®¶å›ºæœ‰ä¼¤å®³';
        if (isEq('snowbear') && finalIceRate > 0) baseLabel += snowbearLabel;

        breakdownList.push({ id:'base', label: baseLabel, val: val_base, freq:0 });
        
        if (cardAtkPct > 0 || val_buff > 1) { 
            breakdownList.push({ id:'buff', label: buffLabel, val: val_buff, freq:0 });
        }

        if (showFlatBreakdown) {
            breakdownList.push({ id:'flat', label:' ä¸¹é’ç™½å­—æ ¸å¿ƒæå‡', val: val_flat, freq:0 });
        }

        if(skillBreakdown.ice > 0) breakdownList.push({ id:'ice', label:' å†°ç®­', val: skillBreakdown.ice, freq: finalIceRate });
        if(skillBreakdown.pulse > 0) breakdownList.push({ id:'pulse', label:' è„‰å†²', val: skillBreakdown.pulse, freq: pulseHitRate });
        if(skillBreakdown.burn > 0) breakdownList.push({ id:'burn', label: skillBreakdown._burnLabel, val: skillBreakdown.burn, freq: 0.3333 });
        if(skillBreakdown.ignite > 0) breakdownList.push({ id:'ignite', label:' äºŒå°¾å¦–ç‹-å¼•ç‡ƒ', val: skillBreakdown.ignite, freq: totalIgniteTriggers });
        if(skillBreakdown.explode > 0) breakdownList.push({ id:'explode', label: skillBreakdown._explodeLabel, val: skillBreakdown.explode, freq: explodeFreq });
        if(skillBreakdown.qihao > 0) breakdownList.push({ id:'qihao', label:' é½æ˜Š-ç„å†°é£æš´', val: skillBreakdown.qihao, freq: 1/(60/(1+finalIceRate)) });

        if (val_snowbear > 0) {
            breakdownList.push({ id:'snowbear', label: snowbearLabel, val: val_snowbear, freq: 0 });
        }

        // --- 7. æ¸²æŸ“ UI ---
        const baselineDps = userInputAtk > 0 ? (userBaseDps * (userInputAtk+extraFlat)/userInputAtk * (1+extraPct/100)) : 0;
        const cardSystemDps = currentTotalDps - baselineDps;

        document.getElementById('currCost').innerText = costSum;
        document.getElementById('res-flatAtk').innerText = Math.round(cardTotalFlatAtk);
        document.getElementById('res-finalAtk').innerText = Math.round(finalAtk);
        document.getElementById('res-totalDps').innerText = Math.round(currentTotalDps).toLocaleString();
        document.getElementById('res-cardSystemDps').innerText = Math.round(cardSystemDps).toLocaleString();

        const inc = baselineDps > 0 ? ((currentTotalDps - baselineDps)/baselineDps * 100) : 0;
        document.getElementById('res-percent').innerText = `+${inc.toFixed(1)}%`;

        const dpsListEl = document.getElementById('dps-list');
        let sortedList = breakdownList.sort((a, b) => dpsSortDir === 'desc' ? b.val - a.val : a.val - b.val);

        const fmtFreq = (f) => {
            if (f <= 0) return '-';
            if (freqMode === 'rate') return f < 0.01 ? '<0.01Hz' : f.toFixed(2) + 'Hz';
            const period = 1/f;
            return period < 0.1 ? '<0.1s' : period.toFixed(2) + 's';
        };

        let html = sortedList.map(obj => {
            if (obj.val <= 0 && obj.freq <= 0 && obj.id !== 'base') return '';
            const pct = currentTotalDps > 0 ? (obj.val / currentTotalDps * 100).toFixed(1) : '0.0';
            const freqStr = obj.freq > 0 ? fmtFreq(obj.freq) : '-';
            
            let color = '#fff'; 
            if(obj.id==='ice') color='#3498db'; 
            if(obj.id==='burn') color='#e74c3c';
            if(obj.id==='pulse') color='#2ecc71'; 
            if(obj.id==='ignite') color='#d35400';
            if(obj.id==='explode') color='#e67e22'; 
            if(obj.id==='qihao') color='#9b59b6';
            if(obj.id==='buff') color='#7f8c8d'; 
            if(obj.id==='flat') color='#00d2d3'; 
            if(obj.id==='snowbear') color='#ff9ff3';

            return `
            <div class="breakdown-row">
                <div class="col-name"><span style="color:${color}">â—</span> ${obj.label}</div>
                <div class="col-freq">${freqStr}</div>
                <div class="col-val" style="color:${color}">${Math.round(obj.val).toLocaleString()}</div>
                <div class="col-pct">${pct}%</div>
            </div>`;
        }).join('');
        
        dpsListEl.innerHTML = html;
        
        const arrow = document.getElementById('sort-arrow');
        arrow.innerText = dpsSortDir === 'desc' ? 'â–¼' : 'â–²';
        arrow.style.color = '#fff'; 
        
        updateExtraEffects(finalAtk);
    }

    function updateExtraEffects(currentAtk = 0) {
        const container = document.getElementById('extra-effects-box');
        const content = document.getElementById('extra-list-content');
        let html = '';
        
        const fmt = (n) => parseFloat(n.toFixed(2));
        
        // ã€ä¿®æ”¹ç‚¹ã€‘ï¼šå»æ‰äº† â‰ˆï¼Œä¿ç•™æ‹¬å·å’Œåƒåˆ†ä½
        const fmtAbs = (pct) => {
            if (!currentAtk) return '';
            const absVal = Math.round(currentAtk * pct / 100);
            return ` <span style="color:#7f8c8d; font-size:11px;">(<span style="color:#2ecc71">${absVal.toLocaleString()}</span>)</span>`;
        };

        const handlers = {
            'xiaohuan': (val) => `ä¼šå¿ƒç­‰çº§ +<span class="highlight">${fmt(val)}</span>`,
            'wilddog': (val) => `åŒ–ä¼¤ä¸ç§½ç­ +<span class="highlight">${fmt(val)}</span>`,
            'turtle': (val) => `ä¸“ç²¾ç­‰çº§ +<span class="highlight">${fmt(val)}</span>`,
            'kite': (val) => `è°ƒæ¯ç­‰çº§ +<span class="highlight">${fmt(val)}</span>`,
            'threetail': (val) => `æ¯å±‚ç‡ƒçƒ§æä¾›é˜²å¾¡ +<span class="highlight">${fmt(val)}</span>`,
            
            'ghostdog': (val) => `å—å‡»å¼•ç‡ƒ (å†…ç½®å†·å´ <span class="highlight">${fmt(val)}</span> ç§’)`,
            
            'zuogui': (val) => `æ°”è¡€æ¢å¤æ•ˆæœæé«˜ <span class="highlight">${fmt(val)}%</span>`,
            'pearl': (val) => `è„‰å†²ä½¿æ°”è¡€æ¢å¤æé«˜ <span class="highlight">${fmt(val)}%</span>`,

            'hehuanbell': (val) => {
                return `å—å‡»å›å¤ <span class="highlight">${fmt(val)}%</span>${fmtAbs(val)} æ”»å‡»åŠ›çš„æ°”è¡€`;
            },
            'fan': (val, lv) => {
                const heal = 4.8 + (1.2 * lv / 6);
                return `è„‰å†²æ²»ç–—é˜Ÿå‹ <span class="highlight">${fmt(heal)}%</span>${fmtAbs(heal)}`;
            },
            'dice': (val, lv) => {
                const heal = 9.0 + (3.0 * lv / 6);
                return `è„‰å†²é¢å¤–æ°”è¡€æ¢å¤ <span class="highlight">${fmt(heal)}%</span>${fmtAbs(heal)}`;
            }
        };

        DB.forEach(c => {
            if (isEq(c.id) && handlers[c.id]) {
                const val = getStatVal(c.id);
                const lv = state[c.id].level;
                const text = handlers[c.id](val, lv);
                
                html += `
                <div class="extra-row">
                    <span class="extra-name">â— ${c.name}</span>
                    <span class="extra-val">${text}</span>
                </div>`;
            }
        });

        content.innerHTML = html;

        if (html === '') {
            container.classList.add('hidden');
        } else {
            container.classList.remove('hidden');
        }
    }

    // ==========================================
    // 3. ç•Œé¢äº¤äº’
    // ==========================================
    
    function makeDots(id, currentLv, isGlobal=false) {
        let html = '';
        for (let i = 1; i <= 6; i++) {
            const isActive = i <= currentLv;
            const clickFn = isGlobal ? `setGlobalLevel(${i})` : `setLevel('${id}', ${i})`;
            html += `<div class="dot ${isActive ? 'active' : ''}" onclick="${clickFn}; event.stopPropagation();"></div>`;
        }
        return html;
    }

    // åˆ‡æ¢ç‚¹å‡»æ¨¡å¼
    function toggleClickMode() {
        isFastMode = !isFastMode;
        const btn = document.getElementById('modeBtn');
        btn.innerText = isFastMode ? "æ¨¡å¼: å•å‡»è£…å¤‡" : "æ¨¡å¼: åŒå‡»è£…å¤‡";
        renderList();
    }

    // åˆ‡æ¢æ’åºæ¨¡å¼
    function toggleSortMode() {
        cardSortMode = cardSortMode === 'type' ? 'cost' : 'type';
        const btn = document.getElementById('sortBtn');
        btn.innerText = cardSortMode === 'type' ? "æ’åº: æŒ‰ç±»åˆ«" : "æ’åº: æŒ‰è´¹ç”¨";
        renderList();
    }
    
    // è·å–è´¹ç”¨é¢œè‰²
    function getCostColor(c) {
        if(c===1) return '#2ecc71';
        if(c===2) return '#3498db';
        if(c===3) return '#9b59b6';
        if(c===4) return '#e67e22';
        return '#e74c3c'; 
    }

    function handleFastClick(id) {
        showDetail(id);
        toggleCard(id);
    }

function renderList() {
        const container = document.getElementById('cardList');
        
        let displayList = [...DB];
        
        // æ’åºé€»è¾‘ (ä¿æŒä¸å˜)
        displayList.sort((a, b) => {
            const typeMap = { human: 1, beast: 2, tool: 3 };
            if (cardSortMode === 'type') {
                if (typeMap[a.type] !== typeMap[b.type]) return typeMap[a.type] - typeMap[b.type];
                return a.cost - b.cost;
            } else {
                if (a.cost !== b.cost) return a.cost - b.cost;
                return typeMap[a.type] - typeMap[b.type];
            }
        });

        container.innerHTML = displayList.map(c => {
            const eventStr = isFastMode 
                ? `onclick="handleFastClick('${c.id}')"` 
                : `onclick="showDetail('${c.id}')" ondblclick="toggleCard('${c.id}')"`;

            return `
            <div class="card-item ${state[c.id].equipped ? 'equipped' : ''} ${currDetail === c.id ? 'active-detail' : ''}" id="row-${c.id}" ${eventStr}>
                
                <div class="card-meta">
                    <span class="card-type type-${c.type}">${c.type==='human'?'äºº':c.type==='beast'?'å…½':'å™¨'}</span>
                    <span class="card-name">${c.name}</span>
                    <span class="card-cost">${c.cost}C</span>
                </div>
                
                <div class="dots-wrapper">
                    ${makeDots(c.id, state[c.id].level)}
                </div>
            </div>
        `}).join('');
        
        document.getElementById('global-dots').innerHTML = makeDots('global', globalLvState, true);
        
        calc();
    }
    function toggleCard(id) {
        state[id].equipped = !state[id].equipped; 
        renderList();
    }

    function setLevel(id, lv) {
        if (state[id].level === lv) {
            state[id].level = 0; 
        } else {
            state[id].level = lv;
        }
        renderList();
        if (currDetail === id) showDetail(id);
    }

    function setGlobalLevel(lv) {
        if (globalLvState === lv) lv = 0;
        globalLvState = lv;
        DB.forEach(c => state[c.id].level = lv);
        renderList();
        if (currDetail) showDetail(currDetail);
    }

    function clearAll() {
        DB.forEach(c => state[c.id].equipped = false);
        renderList();
    }

    function toggleSort() {
        dpsSortDir = dpsSortDir === 'desc' ? 'asc' : 'desc';
        calc();
    }

    function toggleFreqMode() {
        freqMode = freqMode === 'interval' ? 'rate' : 'interval';
        document.getElementById('header-freq-text').innerText = freqMode === 'interval' ? 'è§¦å‘é—´éš”' : 'è§¦å‘é¢‘ç‡';
        calc();
    }

    let currDetail = null;

    function showDetail(id) {
        currDetail = id;
        renderList(); 
        
        const c = DB.find(x => x.id === id);
        let val = getStatVal(id);
        const lv = state[id].level;
        
        const fmt = (n) => parseFloat(n.toFixed(2));
        
        // æ ¼å¼åŒ–ç»å¯¹æ•°å€¼ (1234)
        const fmtAbs = (pct) => {
            if (!g_finalAtk || pct === 0) return '';
            const absVal = Math.round(g_finalAtk * pct / 100);
            return `<span style="color:#7f8c8d; font-size:12px; font-weight:normal;"> (${absVal})</span>`;
        };

        // ã€æ–°å¢ã€‘æ™ºèƒ½æ›¿æ¢å‡½æ•°
        // ä½œç”¨ï¼šå¦‚æœæ–‡æœ¬æ˜¯ "{val}%"ï¼Œä¼šæ›¿æ¢æˆ "æ•°å€¼% (ç»å¯¹å€¼)"ï¼Œè€Œä¸æ˜¯ "æ•°å€¼ (ç»å¯¹å€¼)%"
        const replaceSmart = (text, tag, value, showAbs) => {
            const valHtml = `<span class="highlight">${fmt(value)}</span>`;
            const absHtml = showAbs ? fmtAbs(value) : '';
            
            // ä¼˜å…ˆåŒ¹é…å¸¦ % çš„æƒ…å†µï¼Œè°ƒæ•´é¡ºåº
            if (text.includes(tag + '%')) {
                return text.replace(tag + '%', valHtml + '%' + absHtml);
            }
            // æ™®é€šæƒ…å†µ
            return text.replace(tag, valHtml + absHtml);
        };

        let desc = c.desc;

        const dmgOrHealIds = [
            'yanhong', 'redant', 'twotail', 'sixtail', 
            'fan', 'dice', 'qihao', 'mirror', 
            'hehuanbell'
        ];

        // --- ç‰¹æ®Šå¡ç‰Œå¤„ç† ---
        if (id === 'linfeng') {
            const iceChance = 70 + ((100-70)/6 * lv);
            desc = desc.replace('{val}', `<span class="highlight">${fmt(val)}</span>`)
                        .replace('{ice}', `<span class="highlight">${fmt(iceChance)}</span>`);
        } 
        else if (id === 'fan') { 
            const healVal = 4.8 + (1.2 * lv / 6);
            // ä¼¤å®³
            desc = replaceSmart(desc, '{val}', val, true);
            // æ²»ç–—
            desc = replaceSmart(desc, '{heal}', healVal, true);
        }
        else if (id === 'dice') { 
            const healVal = 9.0 + (3.0 * lv / 6);
            desc = replaceSmart(desc, '{val}', val, true);
            desc = replaceSmart(desc, '{heal}', healVal, true);
        }
        else if (id === 'snowbear') { 
            let linfengIceChance = 0;
            if (state['linfeng'] && state['linfeng'].equipped) {
                linfengIceChance = 0.7 + ((1.0 - 0.7)/6 * state['linfeng'].level);
            }
            let rawIceRate = 0; 
            if (state['yanhong'].equipped) rawIceRate += (1/6);
            if (state['wenmin'].equipped) {
                const wmVal = 16 + (10 - 16) * (state['wenmin'].level / 6);
                rawIceRate += (3 / wmVal);
            }
            let rate = rawIceRate * (1 + linfengIceChance);
            let avgStacks = rate * 10; 
            
            desc = replaceSmart(desc, '{val}', val, false);
            desc = desc.replace('{avgStacks}', `<span class="highlight">${fmt(avgStacks)}</span>`);
        }
        else if (id === 'hehuanbell') {
             desc = replaceSmart(desc, '{val}', val, true);
        }
        else {
            // é€šç”¨å¤„ç†
            const showAbs = dmgOrHealIds.includes(id);
            desc = replaceSmart(desc, '{val}', val, showAbs);
            // é¢‘ç‡ç±»ä¸åšç»å¯¹å€¼å¤„ç†
            desc = desc.replace('{freq}', `<span class="highlight">${fmt(val)}</span>`);
        }

        document.getElementById('detail-content').innerHTML = `
            <div class="detail-title">${c.name} <span style="font-size:12px; color:#999; font-weight:normal;">(Lv.${state[id].level})</span></div>
            <div class="detail-desc">${desc}</div>
        `;
    }
    renderList();
</script>

</body>
</html>