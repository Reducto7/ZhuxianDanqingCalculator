<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>诛仙丹青计算器</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root { 
            --primary: #3498db; 
            --bg: #f5f6fa; 
            --dark: #2c3e50; 
            --panel: #ffffff; 
            --gold: #f1c40f; 
            --gray: #bdc3c7; 
            --card-blue: #3498db; 
            --card-red: #e74c3c;
            --card-green: #27ae60;
        }
        body { font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background: var(--bg); color: var(--dark); margin: 0; padding: 20px; display: flex; justify-content: center; height: 100vh; box-sizing: border-box; overflow: hidden; }
        
        .layout { display: flex; width: 100%; max-width: 1600px; gap: 20px; height: 100%; }
        
        /* --- 左侧面板 (上下分栏布局) --- */
        .card-list-panel { 
            flex: 0 0 720px; 
            display: flex; flex-direction: column; 
            gap: 15px; 
            overflow: hidden; 
            background: transparent; box-shadow: none; /* 去除外层背景，交给子元素 */
        }

        /* 上半部分：列表容器 */
        .panel-top {
            flex: 5;
            background: var(--panel); 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* 下半部分：模拟器容器 */
        .panel-bottom {
            flex: 5;
            background: var(--dark); 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
            display: flex; flex-direction: column;
            overflow: hidden;
            color: white;
        }
        
        /* 列表头部 */
        .list-header { 
            padding: 15px 20px; background: #ecf0f1; border-bottom: 1px solid #bdc3c7; 
            display: flex; justify-content: space-between; align-items: center; user-select: none; 
        }
        
        .header-left-group { display: flex; align-items: center; gap: 15px; }
        .header-title { font-weight: bold; font-size: 18px; color: var(--dark); }
        .global-ctrl { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #7f8c8d; }
        
        /* 按钮组样式 */
        .header-btn-group { display: flex; gap: 10px; }

        .clear-btn { 
            font-size: 12px; cursor: pointer; color: #fff; background: #e74c3c; 
            border: none; padding: 6px 15px; border-radius: 4px; 
            transition: all 0.2s; font-weight: bold;
        }
        .clear-btn:hover { background: #c0392b; box-shadow: 0 2px 5px rgba(231, 76, 60, 0.3); }

        .ctrl-btn {
            font-size: 12px; cursor: pointer; color: #fff; background: #3498db; 
            border: none; padding: 6px 15px; border-radius: 4px; 
            transition: all 0.2s; font-weight: bold; min-width: 80px;
        }
        .ctrl-btn:hover { background: #2980b9; box-shadow: 0 2px 5px rgba(52, 152, 219, 0.3); }

        /* 卡牌滚动区 (3列) */
        .scroll-area { 
            flex: 1; overflow-y: auto; padding: 15px; 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 12px; 
            align-content: start;
        }
        
        /* 卡牌单元格 */
        .card-item { 
            background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; 
            cursor: pointer; transition: all 0.1s; user-select: none;
            display: flex; flex-direction: column; justify-content: center;
            height: 72px; /* 稍微调高 */
            padding: 0 12px; position: relative; gap: 8px;
        }
        .card-item:hover { border-color: #bdc3c7; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.08); }
        .card-item.equipped { 
            background: #eef9fe; 
            border-color: #3498db; 
            box-shadow: 0 0 0 1px #3498db inset; 
        }
        /* 去除详情高亮样式，保持原样 */
        .card-item.active-detail { } 
        
        /* 卡牌内容 */
        .card-meta { display: flex; align-items: center; gap: 6px; }
        .card-name { font-weight: 700; font-size: 15px; color: #333; white-space: nowrap; }
        
        .card-cost { 
            background: #fff; color: #333; border: 1px solid #bdc3c7; 
            font-size: 11px; padding: 2px 5px; border-radius: 3px; font-weight: bold; min-width: 14px; text-align: center;
        }
    
        .card-type { font-size: 10px; padding: 2px 4px; border-radius: 3px; color: white;}
        .type-human { background-color: var(--card-blue); }
        .type-beast { background-color: var(--card-red); }
        .type-tool { background-color: var(--card-green); }

        /* 等级圆点 (变大) */
        .dots-wrapper { display: flex; gap: 6px; align-items: center; }
        .dot { 
            width: 12px; height: 12px; /* 调大 */
            border-radius: 50%; background: #e0e0e0; cursor: pointer; transition: all 0.2s; border: 1px solid transparent; 
        }
        .dot:hover { transform: scale(1.2); border-color: #f1c40f; background: #ccc; }
        .dot.active { background: #f1c40f; box-shadow: 0 0 2px rgba(241, 196, 15, 0.6); }
        
        /* --- 模拟器区域样式 --- */
        .sim-header {
            padding: 15px 20px;
            background: rgba(255,255,255,0.05);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: space-between;
        }
        .sim-title { font-weight: bold; font-size: 18px; color: #f1c40f; }
        .sim-ctrl { display: flex; gap: 10px; align-items: center; }
        
        .sim-info-text { font-size: 12px; color: #7f8c8d; margin-right: 10px; } /* 耗时显示 */

        .sim-input { 
            background: rgba(0,0,0,0.3); border: 1px solid #555; color: white; 
            padding: 6px; border-radius: 4px; width: 60px; text-align: center; font-weight: bold; 
        }
        .sim-btn {
            background: #27ae60; color: white; border: none; padding: 6px 15px; 
            border-radius: 4px; cursor: pointer; font-weight: bold; transition: all 0.2s;
        }
        .sim-btn:hover { background: #2ecc71; }
        .sim-btn:disabled { background: #555; cursor: not-allowed; }

        .sim-results { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; }
        .sim-row {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.05);
            border-radius: 6px; padding: 8px 12px;
            display: flex; align-items: center; justify-content: space-between;
            transition: all 0.1s;
        }
        .sim-row:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); }
        
        /* 排名列 */
        .sim-rank { width: 80px; font-size: 18px; color: #bdc3c7; display: flex; flex-direction: column; justify-content: center; }
        .rank-pct { font-size: 16px; color: #7f8c8d; }
        
        /* DPS列 */
        .sim-dps { 
            font-family: var(--font-stack); /* 统一字体 */
            font-size: 18px; font-weight: bold; color: #f1c40f; 
            min-width: 90px; text-align: right;
        }
        
        .sim-cards { flex: 1; display: flex; gap: 5px; flex-wrap: wrap; margin: 0 15px; }
        .mini-card { 
            font-size: 15px; padding: 2px 6px; border-radius: 3px; background: #34495e; color: #ecf0f1; 
            display: flex; align-items: center; gap: 4px; white-space: nowrap;
        }
        .mini-card.type-human { border-left: 2px solid var(--card-blue); }
        .mini-card.type-beast { border-left: 2px solid var(--card-red); }
        .mini-card.type-tool { border-left: 2px solid var(--card-green); }
        
        .apply-btn {
            background: #3498db; color: white; border: none; padding: 5px 15px;
            border-radius: 3px; cursor: pointer; font-size: 14px;
            margin-left: 20px; /* 增加间距 */
        }
        .apply-btn:hover { background: #5dade2; }


        /* --- 右侧面板 --- */
        .right-panel { flex: 1; display: flex; flex-direction: column; gap: 15px; min-width: 0; }
        
        .detail-card { background: var(--panel); padding: 15px 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); min-height: 80px; }
        .detail-title { font-size: 18px; font-weight: bold; margin-bottom: 5px; color: var(--dark); border-bottom: 2px solid var(--primary); padding-bottom: 5px; display: inline-block;}
        .detail-desc { font-size: 14px; line-height: 1.6; color: #555; }
        .highlight { color: #e74c3c; font-weight: bold; }
        
        /* 仪表盘 */
        .dashboard { flex: 1; background: var(--dark); color: white; border-radius: 12px; padding: 20px; display: flex; flex-direction: column; overflow-y: auto; }
        
        /* 输入控件区 */
        .controls-area { margin-bottom: 15px; display: flex; flex-direction: column; gap: 10px; }

        /* 选项行 */
        .options-row { display: flex; gap: 20px; font-size: 12px; color: #bdc3c7; align-items: center; }
        .chk-label { display: flex; align-items: center; gap: 5px; cursor: pointer; user-select: none; }
        .chk-label input { cursor: pointer; }

        /* 统一的单行数据栏 */
        .unified-row { 
            display: flex; justify-content: space-between; align-items: center; 
            background: rgba(255,255,255,0.08); padding: 15px 20px; border-radius: 8px; 
            margin-bottom: 5px;
        }

        .left-group { display: flex; gap: 15px; align-items: center; }
        .right-group { display: flex; gap: 30px; align-items: center; border-left: 1px solid rgba(255,255,255,0.1); padding-left: 20px;}

        .inp-item { display: flex; flex-direction: column; gap: 5px; }
        .inp-item label { font-size: 12px; color: #95a5a6; font-weight: bold; white-space: nowrap; }
        .inp-item input { 
            background: rgba(0,0,0,0.3); border: 1px solid #555; color: white; 
            padding: 6px; border-radius: 4px; width: 90px; text-align: center; font-weight: bold; font-size: 14px;
        }
        .inp-item input:focus { border-color: var(--primary); outline: none; background: rgba(0,0,0,0.5); }
        
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* 统计数值样式 */
        .stat-box { display: flex; flex-direction: column; align-items: flex-end; }
        .stat-label { font-size: 12px; color: #7f8c8d; margin-bottom: 2px; }
        .stat-val { font-size: 20px; font-weight: bold; line-height: 1.2;}

        .hidden { display: none !important; }

        /* 伤害明细表 */
        .dps-breakdown { background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-top: 10px; flex: 1; overflow-y: auto; }
        
        .breakdown-header { display: flex; padding: 8px 0; border-bottom: 1px solid #7f8c8d; font-size: 12px; color: #bdc3c7; font-weight: bold; user-select: none; }
        .col-name { flex: 2; padding-left: 5px; }
        .col-freq { flex: 1.2; text-align: center; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px; transition: color 0.2s;}
        .col-freq:hover { color: white; }
        .col-val { flex: 1.5; text-align: right; cursor: pointer; display: flex; align-items: center; justify-content: flex-end; gap: 4px; transition: color 0.2s;}
        .col-val:hover { color: white; }
        .col-pct { flex: 0.8; text-align: right; }
        
        .breakdown-row { display: flex; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 13px; align-items: center; }
        .breakdown-row:last-child { border-bottom: none; }
        .breakdown-row:hover { background: rgba(255,255,255,0.05); }

        /* 额外效果区域样式 */
        .extra-box {
            background: rgba(255,255,255,0.03);
            border: 1px dashed rgba(255,255,255,0.15);
            border-radius: 8px;
            padding: 10px 15px;
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .extra-title {
            font-size: 12px;
            font-weight: bold;
            color: #f39c12; /* 橙黄色标题 */
            margin-bottom: 5px;
            opacity: 0.9;
        }
        .extra-row {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #95a5a6;
            padding: 2px 0;
            border-bottom: 1px solid rgba(255,255,255,0.02);
        }
        .extra-row:last-child { border-bottom: none; }
        .extra-name { color: #bdc3c7; }
        .extra-val { color: #ecf0f1; }
        .extra-val .highlight { color: #2ecc71; font-weight: bold; } 

        .footer-info {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.05); 
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .copyright {
            font-size: 12px;
            color: #7f8c8d;
            font-family: Consolas, Monaco, monospace;
        }

        .visit-stats {
            font-size: 10px; 
            color: #555;     
        }
        
        .final-result { 
            margin-top: auto; padding-top: 20px; 
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; 
        }
        .res-card { 
            background: rgba(255,255,255,0.08); border-radius: 8px; padding: 10px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .res-card-label { font-size: 12px; color: #bdc3c7; margin-bottom: 5px; }
        .res-card-val { font-size: 22px; font-weight: bold; }
        
        .c-total { color: #f1c40f; }
        .c-system { color: #3498db; }
        .c-inc { color: #2ecc71; }
        
        .sort-arrow { font-size: 10px; opacity: 0.5; }

        /* =========================================
           移动端适配 (响应式布局)
           ========================================= */
        @media screen and (max-width: 1024px) {
            body {
                height: auto;
                overflow-y: auto; 
                -webkit-overflow-scrolling: touch; 
            }

            .layout {
                flex-direction: column;
                height: auto;
            }

            .card-list-panel {
                flex: none;
                width: 100%;
                height: auto; 
                max-height: none; 
                margin-bottom: 0px;
                /* 移动端不分栏，或者垂直堆叠 */
            }
            
            .panel-top { flex: none; height: 400px; }
            .panel-bottom { flex: none; height: auto; }

            .list-header {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
                height: auto;
                padding: 15px;
            }

            .header-left-group { width: 100%; justify-content: space-between; }
            .header-btn-group { width: 100%; display: flex; gap: 10px; }
            .ctrl-btn, .clear-btn { flex: 1; text-align: center; padding: 8px 0; }

            .scroll-area {
                flex: none !important;
                height: 300px !important; 
                overflow-y: auto !important;
                grid-template-columns: repeat(2, 1fr); 
            }

            .right-panel { width: 100%; flex: none; }

            .unified-row {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }

            .left-group {
                width: 100%;
                justify-content: space-between;
                border-left: none;
                padding-left: 0;
                flex-wrap: wrap; 
                gap: 10px; 
            }
            .inp-item { width: 48%; }
            .inp-item input { width: 100%; box-sizing: border-box; }
            
            .right-group {
                width: 100%;
                justify-content: space-between;
                border-top: 1px solid rgba(255,255,255,0.1);
                padding-top: 15px;
                border-left: none; padding-left: 0;
            }

            .final-result { grid-template-columns: 1fr; gap: 10px; }
            .stat-val { font-size: 18px; }
            .card-item { height: auto; padding: 10px; }
            .footer-info { margin-bottom: 30px; }
            .copyright { gap: 5px; }
        }
        
    </style>
</head>
<body>

<div class="layout">
    <div class="card-list-panel">
        
        <div class="panel-top">
            <div class="list-header">
                <div class="header-left-group">
                    <span class="header-title">丹青配置</span>
                    <div class="global-ctrl">
                        <span>一键调整:</span>
                        <div class="dots-wrapper" id="global-dots"></div>
                    </div>
                </div>
                
                <div class="header-btn-group">
                    <button class="ctrl-btn" id="sortBtn" onclick="toggleSortMode()">排序: 按类别</button>
                    <button class="ctrl-btn" id="modeBtn" onclick="toggleClickMode()">模式: 双击装备</button>
                    <button class="clear-btn" onclick="clearAll()">清空选择</button>
                </div>
            </div>
            
            <div class="scroll-area" id="cardList"></div>
        </div>

        <div class="panel-bottom">
            <div class="sim-header">
                <div class="sim-title">
                    <span>自动模拟最优解</span>
                </div>
                <div class="sim-ctrl">
                    <span id="sim-time" class="sim-info-text"></span>
                    <label style="font-size:12px; color:#bdc3c7;">可用 Cost:</label>
                    <input type="number" id="sim-cost" class="sim-input" value="15">
                    <button class="sim-btn" onclick="runSimulation()" id="btn-sim">开始计算</button>
                </div>
            </div>
            <div class="sim-results" id="sim-results">
                <div style="text-align:center; color:#7f8c8d; padding-top:20px; font-size:13px; line-height:1.5;">
                    输入 Cost 限制，点击计算，自动寻找最高秒伤组合<br>
                </div>
            </div>
        </div>

    </div>

    <div class="right-panel">
        
        <div class="detail-card">
            <div id="detail-content">
                <div style="color: #ccc; padding-top: 15px; text-align: center;">单击卡牌查看详情 / 双击装备或卸下</div>
            </div>
        </div>

        <div class="dashboard">
            <div class="controls-area">
                <div class="options-row">
                    <label class="chk-label">
                        <input type="checkbox" id="chk-showFlat" onchange="calc()" checked> 
                        独立显示丹青白字攻击提升占比
                    </label>
                    <label class="chk-label">
                        <input type="checkbox" id="chk-dilution" onchange="toggleDilution()"> 
                        考虑其他攻击力提升稀释
                    </label>
                </div>

                <div class="unified-row">
                    <div class="left-group">
                        <div class="inp-item">
                            <label>玩家基础攻击力</label>
                            <input type="number" id="baseAtk" value="10000" oninput="calc()">
                        </div>
                        <div class="inp-item">
                            <label>玩家固有DPS</label>
                            <input type="number" id="baseDps" value="50000" oninput="calc()">
                        </div>
                        
                        <div class="inp-item hidden" id="dilution-pct-box">
                            <label style="color:#e67e22">其他攻击(%)</label>
                            <input type="number" id="extraPct" value="4" oninput="calc()" style="border-color:#e67e22">
                        </div>
                        <div class="inp-item hidden" id="dilution-flat-box">
                            <label style="color:#e67e22">其他白字</label>
                            <input type="number" id="extraFlat" value="0" oninput="calc()" style="border-color:#e67e22">
                        </div>
                    </div>

                    <div class="right-group">
                        <div class="stat-box">
                            <div class="stat-label">总 Cost 花费</div>
                            <div class="stat-val" style="color:#f1c40f;"><span id="currCost">0</span></div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">丹青核心攻击</div>
                            <div class="stat-val" style="color:#3498db;" id="res-flatAtk">0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">最终攻击力</div>
                            <div class="stat-val" style="color:#fff;" id="res-finalAtk">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="font-size:12px; color:#95a5a6;">伤害构成分析</div>
            </div>
            
            <div class="dps-breakdown">
                <div class="breakdown-header">
                    <div class="col-name">伤害来源</div>
                    
                    <div class="col-freq" onclick="toggleFreqMode()">
                        <span id="header-freq-text">触发间隔</span>
                        <span style="font-size:10px;">⇄</span>
                    </div>

                    <div class="col-val" onclick="toggleSort()">
                        <span>秒伤 (DPS)</span>
                        <span class="sort-arrow" id="sort-arrow">▼</span>
                    </div>
                    
                    <div class="col-pct">占比</div>
                </div>
                <div id="dps-list">
                    </div>
            </div>

            <div id="extra-effects-box" class="extra-box hidden">
                <div class="extra-title">其它生效属性 (不计入DPS)</div>
                <div id="extra-list-content"></div>
            </div>

            <div class="final-result">
                <div class="res-card">
                    <div class="res-card-label">总秒伤 (Total)</div>
                    <div class="res-card-val c-total" id="res-totalDps">0</div>
                </div>

                <div class="res-card">
                    <div class="res-card-label">丹青提供秒伤</div>
                    <div class="res-card-val c-system" id="res-cardSystemDps">0</div>
                </div>

                <div class="res-card">
                    <div class="res-card-label">丹青提供增幅</div>
                    <div class="res-card-val c-inc" id="res-percent">+0.0%</div>
                </div>
            </div>

            <div class="footer-info">
                <div class="copyright">
                    <span class="credit-item">制作: <span class="author">鱼夕@一剑诛仙</span></span>
                    <span class="divider">|</span>
                    <span class="credit-item">数据: <span class="author">逍遥子@星河入梦</span></span>
                </div>
                
                <div class="visit-stats">
                    <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" 
                            onerror="console.log('不蒜子统计加载失败，可能是被广告插件拦截或服务不稳定');"></script>
                    
                    <span id="busuanzi_container_site_pv"> 
                        Total Views: <span id="busuanzi_value_site_pv" style="color:#2ecc71">--</span>
                        <span style="margin:0 5px; opacity:0.3">|</span>
                        Visitors: <span id="busuanzi_value_site_uv" style="color:#3498db">--</span>
                    </span>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // ==========================================
    // 1. 数据定义
    // ==========================================
    const Linear = (v0, v6) => ({ type: 'linear', v0, v6 });
    const Fixed = (v) => ({ type: 'fixed', val: v });

    const FLAT_ATK_V0 = 44.9;
    const FLAT_ATK_V6 = 58.2;

    const DB = [
        // --- A类 (核心) ---
        { id: 'yanhong', name: '燕虹', type: 'human', cost: 1, desc: '冰箭基础伤害 {val}% 攻击力', stat: Linear(28, 40), effect: 'ice_base', simType: 'A' },
        { id: 'redant', name: '猩红巨蚁', type: 'beast', cost: 1, desc: '燃烧基础伤害 {val}% 攻击力 (每3秒一跳)', stat: Linear(1.4, 2), effect: 'burn_base', simType: 'A' },
        { id: 'woodsword', name: '木剑', type: 'tool', cost: 1, desc: '攻击力增加 {val}% (固定)', stat: Linear(0.56, 0.80), effect: 'fixed_atk', simType: 'A' },
        { id: 'fan', name: '折扇', type: 'tool', cost: 1, desc: '脉冲基础伤害 {val}% 攻击力 (每15秒)', stat: Linear(40, 52), effect: 'pulse_base', simType: 'A' },
        
        { id: 'zhou', name: '周一仙', type: 'human', cost: 2, desc: '每有一张人族卡，攻击力增加 {val}%', stat: Linear(0.56, 0.80), effect: 'count_race_atk', simType: 'A' },
        { id: 'wenmin', name: '文敏', type: 'human', cost: 2, desc: '每 {freq} 秒发射3支冰箭', stat: {v0: 16, v6: 10}, effect: 'ice_add_freq', simType: 'A' },
        { id: 'shangguan', name: '上官策', type: 'human', cost: 2, desc: '冰箭有 {val}% 概率附加燃烧', stat: Linear(38, 50), effect: 'ice_trigger_burn', simType: 'A' },
        { id: 'tiger', name: '猛虎', type: 'beast', cost: 2, desc: '每有一张兽族卡，攻击力增加 {val}%', stat: Linear(0.56, 0.80), effect: 'count_race_atk', simType: 'A' },
        { id: 'twotail', name: '二尾妖狐', type: 'beast', cost: 2, desc: '引燃：每次施加燃烧(含林峰额外触发)时，瞬间造成 {val}% 伤害', stat: Linear(28, 40), effect: 'burn_on_hit', simType: 'A' },
        { id: 'banner', name: '仙人布幡', type: 'tool', cost: 2, desc: '每有一张器族卡，攻击力增加 {val}%', stat: Linear(0.56, 0.80), effect: 'count_race_atk', simType: 'A' },
        { id: 'dice', name: '神木骰', type: 'tool', cost: 2, desc: '脉冲追加 {val}% 伤害(忽略进场效果)', stat: Fixed(70), effect: 'dice_buff', simType: 'A' },
        
        { id: 'linfeng', name: '林峰', type: 'human', cost: 3, desc: '燃烧判定时{val}%概率多一次判定(触发引燃)，召唤冰箭{ice}%概率多一根', stat: Linear(42, 60), effect: 'linfeng_dual', simType: 'A' }, 
        { id: 'suishou', name: '岁兽', type: 'beast', cost: 3, desc: '脉冲命中时 {val}% 概率添加3层燃烧(视为3次独立施加)', stat: Linear(70, 100), effect: 'pulse_trigger_burn', simType: 'A' },
        { id: 'bamboo', name: '寒冰箭', type: 'tool', cost: 3, desc: '每 {freq} 次冰箭触发一次脉冲', stat: {v0: 16, v6: 10}, effect: 'ice_count_pulse', simType: 'A' },
        
        { id: 'zuogui', name: '左归', type: 'human', cost: 4, desc: '所有丹青特效伤害提升 {val}%', stat: Linear(28, 40), effect: 'global_dmg_mult', simType: 'A' },
        { id: 'snowbear', name: '雪地熊', type: 'beast', cost: 4, desc: '召唤冰箭增加伤害 {val}% (未实装)', stat: Linear(0.38, 0.5), effect: 'snowbear_buff', simType: 'A' },
        
        { id: 'qihao', name: '齐昊', type: 'human', cost: 5, desc: '60秒一次玄冰风暴({val}%伤害)，每冰箭减1秒CD', stat: Linear(1040, 1400), effect: 'qihao_nuke', simType: 'A' },
        { id: 'sixtail', name: '六尾魔狐', type: 'beast', cost: 5, desc: '燃烧8层引爆，造成每层 {val}% 的AOE伤害并清层', stat: Linear(50, 68), effect: 'sixtail_explode', simType: 'A' },
        { id: 'mirror', name: '六合镜', type: 'tool', cost: 5, desc: '脉冲50%概率回响，造成4次 {val}% 伤害', stat: Linear(140, 200), effect: 'mirror_echo', simType: 'A' },

        // --- B类 (挂件) ---
        // T1: 进攻类
        { id: 'xiaohuan', name: '小环', type: 'human', cost: 1, desc: '会心 +{val}', stat: Linear(280, 400), effect: 'crit_flat', simType: 'B', simTier: 1 },
        { id: 'turtle', name: '海龟', type: 'beast', cost: 1, desc: '专精 +{val}', stat: Linear(280, 400), effect: 'mastery_flat', simType: 'B', simTier: 1 },
        { id: 'kite', name: '风筝', type: 'tool', cost: 1, desc: '调息 +{val}', stat: Linear(280, 400), effect: 'haste_flat', simType: 'B', simTier: 1 },
        
        // T2: 生存类
        { id: 'ghostdog', name: '幽冥犬', type: 'beast', cost: 2, desc: '被攻击添加燃烧 (不计入DPS)', stat: Fixed(0), effect: 'none', simType: 'B', simTier: 2 },
        { id: 'pearl', name: '清凉珠', type: 'tool', cost: 3, desc: '触发脉冲时，自身气血恢复效果提高{val}%，持续10秒。', stat: Linear(2.8, 4), effect: 'none', simType: 'B', simTier: 2 },
        { id: 'threetail', name: '三尾妖狐', type: 'beast', cost: 4, desc: '每个激活的燃烧使自身防御力提高{val}', stat: Linear(140, 200), effect: 'none', simType: 'B', simTier: 2 },
        { id: 'hehuanbell', name: '合欢铃', type: 'tool', cost: 4, desc: '受到伤害时，恢复{val}%攻击力的气血。', stat: Linear(680, 800), effect: 'none', simType: 'B', simTier: 2 },

        // --- Excluded ---
        { id: 'wilddog', name: '野狗道人', type: 'human', cost: 1, desc: '化伤和秽灭提高{val}', stat: Linear(56, 80), effect: 'none', simType: 'X' },
    ];

    const state = {};
    DB.forEach(c => state[c.id] = { equipped: false, level: 6 });

    // UI State
    let dpsSortDir = 'desc'; 
    let freqMode = 'interval'; 
    let globalLvState = 6;
    
    // 点击模式与排序模式
    let isFastMode = false;
    let cardSortMode = 'type'; // 'type' | 'cost'

    let g_finalAtk = 0; // 全局缓存，用于详情显示绝对值

    // ==========================================
    // 2. 逻辑计算
    // ==========================================

    function getStatVal(cardId, overrideLv) {
        const card = DB.find(c => c.id === cardId);
        const lv = (overrideLv !== undefined) ? overrideLv : state[cardId].level;
        const s = card.stat;
        if (s.type === 'fixed') return s.val;
        return s.v0 + (s.v6 - s.v0) * (lv / 6);
    }
    
    function getCardFlatAtk(cardId, overrideLv) {
        const c = DB.find(x => x.id === cardId);
        const lv = (overrideLv !== undefined) ? overrideLv : state[cardId].level;
        const range = FLAT_ATK_V6 - FLAT_ATK_V0;
        const baseFlat = FLAT_ATK_V0 + range * (lv / 6);
        return baseFlat * c.cost;
    }

    const isEq = (id) => state[id].equipped;

    function toggleDilution() {
        const checked = document.getElementById('chk-dilution').checked;
        const box1 = document.getElementById('dilution-pct-box');
        const box2 = document.getElementById('dilution-flat-box');
        if (checked) {
            box1.classList.remove('hidden');
            box2.classList.remove('hidden');
        } else {
            box1.classList.add('hidden');
            box2.classList.add('hidden');
        }
        calc();
    }

    // --- 模拟器专用计算核心 ---
    let _cachedInputs = {}; 

    function calculateDpsCore(equippedSet, inputs) {
        // 1. 统计
        let countHuman=0, countBeast=0, countTool=0;
        let cardTotalFlatAtk = 0;
        
        equippedSet.forEach(id => {
            const c = DB.find(x => x.id === id);
            if(c.type === 'human') countHuman++;
            if(c.type === 'beast') countBeast++;
            if(c.type === 'tool') countTool++;
            cardTotalFlatAtk += getCardFlatAtk(id); 
        });

        // 2. 攻击力
        let cardAtkPct = 0;
        if(equippedSet.has('zhou')) cardAtkPct += getStatVal('zhou') * countHuman;
        if(equippedSet.has('tiger')) cardAtkPct += getStatVal('tiger') * countBeast;
        if(equippedSet.has('banner')) cardAtkPct += getStatVal('banner') * countTool;
        if(equippedSet.has('woodsword')) cardAtkPct += getStatVal('woodsword');

        const totalPct = inputs.extraPct + cardAtkPct; 
        const realBaseAtk = inputs.userInputAtk + inputs.extraFlat + cardTotalFlatAtk; 
        const finalAtk = realBaseAtk * (1 + totalPct/100); 

        // 3. 特效
        const isEqInSim = (id) => equippedSet.has(id);
        const getRatio = (id) => {
            if (isEqInSim(id)) return getStatVal(id);
            const c = DB.find(x => x.id === id);
            return c.stat.v0 + (c.stat.v6 - c.stat.v0) * (-1 / 6);
        };

        let zuoguiMult = 1.0; 
        if (isEqInSim('zuogui')) zuoguiMult += (getStatVal('zuogui') / 100);

        let linfengIceChance = 0, linfengBurnChance = 0;
        if (isEqInSim('linfeng')) {
            linfengBurnChance = getStatVal('linfeng') / 100;
            linfengIceChance = 0.7 + ((1.0 - 0.7)/6 * state['linfeng'].level);
        }

        let rawIceRate = 0; 
        if (isEqInSim('yanhong')) rawIceRate += (1/6);
        if (isEqInSim('wenmin')) rawIceRate += (3 / getStatVal('wenmin'));
        let finalIceRate = rawIceRate * (1 + linfengIceChance);

        let snowbearMult = 1.0;
        if (isEqInSim('snowbear') && finalIceRate > 0) {
            const avgStacks = finalIceRate * 10;
            snowbearMult = 1 + (avgStacks * getStatVal('snowbear') / 100);
        }

        let pulseRate = 0;
        if (isEqInSim('fan')) pulseRate += (1/15);
        if (isEqInSim('bamboo') && finalIceRate > 0) pulseRate += (finalIceRate / getStatVal('bamboo'));
        let pulseHitRate = pulseRate; 

        let eventRedant = isEqInSim('redant') ? (1/8.0) : 0;
        let eventShangguan = isEqInSim('shangguan') ? (finalIceRate * getStatVal('shangguan')/100) : 0;
        let eventSuishou = 0;
        if (isEqInSim('suishou')) eventSuishou = (pulseHitRate * (getStatVal('suishou') / 100)) * 3;
        
        let totalIgniteTriggers = (eventRedant + eventShangguan + eventSuishou) * (1 + linfengBurnChance);
        let finalStackRate = totalIgniteTriggers; 

        // 4. 伤害汇总
        let fullSkillDps = 0;

        if (finalIceRate > 0) fullSkillDps += finalAtk * (getRatio('yanhong') / 100) * snowbearMult * zuoguiMult * finalIceRate;
        
        if (pulseHitRate > 0) {
            let pVal = finalAtk * ((getRatio('fan') + (isEqInSim('dice')?getStatVal('dice'):0)) / 100) * snowbearMult * zuoguiMult * pulseHitRate;
            if (isEqInSim('mirror')) pVal += finalAtk * (getStatVal('mirror') / 100) * snowbearMult * zuoguiMult * pulseHitRate * 0.5 * 4;
            fullSkillDps += pVal;
        }
        
        if (finalStackRate > 0) {
            let avgStacks = 12;
            let explodeFreq = 0;
            let explodeStacks = 0;
            if (isEqInSim('sixtail')) {
                const timeTo8 = 8 / finalStackRate;
                explodeStacks = Math.min(12, 8 + finalStackRate * 1.5);
                explodeFreq = 1 / (timeTo8 + 1.5);
                avgStacks = explodeStacks * 0.55;
            }
            fullSkillDps += finalAtk * (getRatio('redant') / 100) * avgStacks * snowbearMult * zuoguiMult * (1/3);
            if (isEqInSim('sixtail')) fullSkillDps += finalAtk * (getStatVal('sixtail') / 100) * explodeStacks * snowbearMult * explodeFreq;
        }
        
        if (isEqInSim('twotail')) fullSkillDps += finalAtk * (getStatVal('twotail') / 100) * snowbearMult * totalIgniteTriggers;
        
        if (isEqInSim('qihao')) {
            let qFreq = 1 / (60 / (1 + finalIceRate));
            fullSkillDps += finalAtk * (getStatVal('qihao') / 100) * snowbearMult * zuoguiMult * qFreq;
        }

        let fullSwingDps = inputs.userInputAtk > 0 ? (inputs.userBaseDps * finalAtk / inputs.userInputAtk * snowbearMult) : 0;

        return fullSwingDps + fullSkillDps;
    }

    // ==========================================
    // 模拟器逻辑 (A类穷举 + B类贪心)
    // ==========================================
    function runSimulation() {
        const btn = document.getElementById('btn-sim');
        const resDiv = document.getElementById('sim-results');
        const timeSpan = document.getElementById('sim-time');
        const maxCost = parseInt(document.getElementById('sim-cost').value) || 10;
        
        btn.disabled = true;
        btn.innerText = "计算中";
        resDiv.innerHTML = '<div style="text-align:center; padding:20px; color:#bdc3c7;">正在模拟最优方案...</div>';
        timeSpan.innerText = '';

        // 缓存输入
        _cachedInputs = {
            userInputAtk: parseFloat(document.getElementById('baseAtk').value) || 0,
            userBaseDps: parseFloat(document.getElementById('baseDps').value) || 0,
            extraPct: 0, extraFlat: 0
        };
        if (document.getElementById('chk-dilution').checked) {
            _cachedInputs.extraPct = parseFloat(document.getElementById('extraPct').value) || 0;
            _cachedInputs.extraFlat = parseFloat(document.getElementById('extraFlat').value) || 0;
        }

        setTimeout(() => {
            const start = performance.now();
            
            // 分类卡池
            const corePool = DB.filter(c => c.simType === 'A').sort((a,b) => b.cost - a.cost);
            const fillerPool = DB.filter(c => c.simType === 'B');
            
            let bestResults = []; 

            function updateResults(ids, dps) {
                if (bestResults.length < 5) {
                    bestResults.push({ ids: new Set(ids), dps });
                    bestResults.sort((a,b) => b.dps - a.dps);
                } else if (dps > bestResults[4].dps) {
                    bestResults[4] = { ids: new Set(ids), dps };
                    bestResults.sort((a,b) => b.dps - a.dps);
                }
            }

            // 贪心填充 B 类卡
            function fillRestCost(currentIds, remainingCost) {
                if (remainingCost <= 0) return new Set(currentIds);
                
                let filledIds = new Set(currentIds);
                let currentRem = remainingCost;
                
                // 检测羁绊
                const hasZhou = filledIds.has('zhou');
                const hasTiger = filledIds.has('tiger');
                const hasBanner = filledIds.has('banner');

                // 动态计算挂件权值
                let availableFillers = fillerPool.map(c => {
                    let score = (c.simTier === 1) ? 20 : 10; // T1优先级更高
                    if (c.type === 'human' && hasZhou) score += 1000;
                    if (c.type === 'beast' && hasTiger) score += 1000;
                    if (c.type === 'tool' && hasBanner) score += 1000;
                    return { ...c, score };
                }).sort((a, b) => b.score - a.score); // 按优先级降序

                // 贪心塞入
                for (let card of availableFillers) {
                    if (currentRem >= card.cost && !filledIds.has(card.id)) {
                        filledIds.add(card.id);
                        currentRem -= card.cost;
                    }
                    if (currentRem === 0) break;
                }
                
                return filledIds;
            }

            // DFS 只遍历 A 类
            function dfs(index, currentCost, currentIds) {
                let canAddCore = false;
                for (let i = index; i < corePool.length; i++) {
                    const card = corePool[i];
                    if (currentCost + card.cost <= maxCost) {
                        canAddCore = true;
                        currentIds.add(card.id);
                        dfs(i + 1, currentCost + card.cost, currentIds);
                        currentIds.delete(card.id);
                    }
                }

                // 无法再加入核心卡时，尝试填充挂件
                if (!canAddCore) {
                    const finalSet = fillRestCost(currentIds, maxCost - currentCost);
                    const dps = calculateDpsCore(finalSet, _cachedInputs);
                    updateResults(finalSet, dps);
                }
            }

            dfs(0, 0, new Set());

            const time = performance.now() - start;
            renderSimResults(bestResults, time);
            
            btn.disabled = false;
            btn.innerText = "开始计算";
        }, 50);
    }

    function renderSimResults(results, time) {
        const div = document.getElementById('sim-results');
        document.getElementById('sim-time').innerText = `耗时: ${time.toFixed(0)}ms`;

        if (results.length === 0) {
            div.innerHTML = '<div style="text-align:center;">没有找到符合条件的组合</div>';
            return;
        }

        const maxDps = results[0].dps;
        let html = '';
        
        results.forEach((res, idx) => {
            let cardBadges = '';
            let sortedIds = Array.from(res.ids).sort((a,b) => {
                const ca = DB.find(x=>x.id===a);
                const cb = DB.find(x=>x.id===b);
                // 显示时A类在前，B类在后，内部按Cost降序
                if (ca.simType !== cb.simType) return ca.simType === 'A' ? -1 : 1;
                return cb.cost - ca.cost;
            });

            sortedIds.forEach(id => {
                const c = DB.find(x=>x.id===id);
                // 挂件卡稍微淡一点显示
                const opacity = c.simType === 'B' ? '0.8' : '1';
                cardBadges += `<span class="mini-card type-${c.type}" style="opacity:${opacity}">${c.name} <span style="opacity:0.6">${c.cost}</span></span>`;
            });

            const idString = sortedIds.join(',');
            const pct = (res.dps / maxDps * 100).toFixed(1);

            html += `
            <div class="sim-row">
                <div class="sim-rank">
                    <div style="font-weight:bold; color:#fff;">#${idx+1}</div>
                    <div class="rank-pct">${pct}%</div>
                </div>
                <div class="sim-cards">${cardBadges}</div>
                <div class="sim-dps">${Math.round(res.dps).toLocaleString()}</div>
                <button class="apply-btn" onclick="applyBuild('${idString}')">应用</button>
            </div>
            `;
        });
        div.innerHTML = html;
    }

    function applyBuild(idStr) {
        const ids = idStr.split(',');
        DB.forEach(c => {
            state[c.id].equipped = ids.includes(c.id);
        });
        renderList(); 
        calc(); 
    }


    function calc() {
        // --- 0. 基础输入与选项读取 ---
        const userInputAtk = parseFloat(document.getElementById('baseAtk').value) || 0;
        const userBaseDps = parseFloat(document.getElementById('baseDps').value) || 0;
        
        const showFlatBreakdown = document.getElementById('chk-showFlat').checked;
        const useDilution = document.getElementById('chk-dilution').checked;

        let extraPct = 0; 
        let extraFlat = 0; 

        if (useDilution) {
            extraPct = parseFloat(document.getElementById('extraPct').value) || 0;
            extraFlat = parseFloat(document.getElementById('extraFlat').value) || 0;
        }

        // --- 1. 统计卡牌数据 ---
        let countHuman = 0, countBeast = 0, countTool = 0;
        let costSum = 0;
        let cardTotalFlatAtk = 0; 

        DB.forEach(c => {
            if (isEq(c.id)) {
                costSum += c.cost;
                if (c.type === 'human') countHuman++;
                if (c.type === 'beast') countBeast++;
                if (c.type === 'tool') countTool++;
                cardTotalFlatAtk += getCardFlatAtk(c.id);
            }
        });

        // 丹青提供的攻击力百分比
        let cardAtkPct = 0;
        if (isEq('zhou')) cardAtkPct += getStatVal('zhou') * countHuman;
        if (isEq('tiger')) cardAtkPct += getStatVal('tiger') * countBeast;
        if (isEq('banner')) cardAtkPct += getStatVal('banner') * countTool;
        if (isEq('woodsword')) cardAtkPct += getStatVal('woodsword');

        // --- 2. 核心数值计算 ---
        const totalPct = extraPct + cardAtkPct; 
        const realBaseAtk = userInputAtk + extraFlat + cardTotalFlatAtk; 
        const finalAtk = realBaseAtk * (1 + totalPct/100); 

        // 更新全局变量
        g_finalAtk = finalAtk;

        // 收益拆解
        // 纯百分比加成带来的收益
        const bonusDpsFromPct = userBaseDps * (1 + cardAtkPct/100) - userBaseDps; 
        // 白字提升系数 (占最终攻击的比例)
        const flatAtkContributionRatio = (finalAtk > 0) ? (cardTotalFlatAtk * (1 + totalPct/100)) / finalAtk : 0;

        // --- 3. 丹青特效参数计算 ---
        
        // 基础技能系数计算 helper
        const getDmgRatio = (id) => {
            if (isEq(id)) return getStatVal(id); 
            const c = DB.find(x => x.id === id);
            return c.stat.v0 + (c.stat.v6 - c.stat.v0) * (-1 / 6);
        };

        const ratios = {
            ice: getDmgRatio('yanhong'), 
            burn: getDmgRatio('redant'), 
            pulse: getDmgRatio('fan'),
            qihao: getStatVal('qihao'), 
            foxExplode: getStatVal('sixtail'), 
            ignite: getStatVal('twotail'),
            mirror: getStatVal('mirror'), 
            dice: getStatVal('dice'), 
            suishouChance: getStatVal('suishou'),
            snowbear: getStatVal('snowbear')
        };

        let zuoguiMult = 1.0; 
        if (isEq('zuogui')) zuoguiMult += (getStatVal('zuogui') / 100);

        let linfengIceChance = 0, linfengBurnChance = 0;
        if (isEq('linfeng')) {
            linfengBurnChance = getStatVal('linfeng') / 100;
            linfengIceChance = 0.7 + ((1.0 - 0.7)/6 * state['linfeng'].level);
        }

        let rawIceRate = 0; 
        if (isEq('yanhong')) rawIceRate += (1/6);
        if (isEq('wenmin')) rawIceRate += (3 / getStatVal('wenmin'));
        let finalIceRate = rawIceRate * (1 + linfengIceChance);

        let snowbearMult = 1.0;
        let snowbearLabel = '';
        if (isEq('snowbear') && finalIceRate > 0) {
            const avgStacks = finalIceRate * 10;
            snowbearMult = 1 + (avgStacks * ratios.snowbear / 100);
            snowbearLabel = ` 雪地熊全局增伤 (均${avgStacks.toFixed(1)}层)`;
        }

        let pulseRate = 0;
        if (isEq('fan')) pulseRate += (1/15);
        if (isEq('bamboo') && finalIceRate > 0) pulseRate += (finalIceRate / getStatVal('bamboo'));
        let pulseHitRate = pulseRate; 

        let eventRedant = isEq('redant') ? (1/8) : 0;
        let eventShangguan = isEq('shangguan') ? (finalIceRate * getStatVal('shangguan')/100) : 0;
        let eventSuishou = 0;
        if (isEq('suishou')) eventSuishou = (pulseHitRate * (ratios.suishouChance / 100)) * 3;
        
        let totalIgniteTriggers = (eventRedant + eventShangguan + eventSuishou) * (1 + linfengBurnChance);
        let finalStackRate = totalIgniteTriggers; 

        // --- 4. 伤害计算 ---
        let explodeFreq = 0;
        let explodeStacks = 0; 
        if (isEq('sixtail') && finalStackRate > 0) {
            const timeTo8 = 8 / finalStackRate;
            explodeStacks = Math.min(12, 8 + finalStackRate * 1.5);
            const cycleTime = timeTo8 + 1.5;
            explodeFreq = 1 / cycleTime;
        }

        // 平砍
        let fullSwingDps = userInputAtk > 0 ? (userBaseDps * finalAtk / userInputAtk * snowbearMult) : 0;

        let skillBreakdown = { ice:0, pulse:0, burn:0, ignite:0, explode:0, qihao:0 };
        let fullSkillDps = 0;

        if (finalIceRate > 0) {
            skillBreakdown.ice = finalAtk * (ratios.ice / 100) * snowbearMult * zuoguiMult * finalIceRate;
            fullSkillDps += skillBreakdown.ice;
        }
        
        if (pulseHitRate > 0) {
            let val = finalAtk * ((ratios.pulse + (isEq('dice')?ratios.dice:0)) / 100) * snowbearMult * zuoguiMult * pulseHitRate;
            if (isEq('mirror')) val += finalAtk * (ratios.mirror / 100) * snowbearMult * zuoguiMult * pulseHitRate * 0.5 * 4;
            skillBreakdown.pulse = val;
            fullSkillDps += val;
        }
        
        if (finalStackRate > 0) {
            let avgStacks = 12;
            let labelSuffix = '(12层)';
            if (isEq('sixtail')) {
                avgStacks = explodeStacks * 0.55; 
                labelSuffix = `(动态均值${avgStacks.toFixed(1)}层)`;
            }
            let val = finalAtk * (ratios.burn / 100) * avgStacks * snowbearMult * zuoguiMult * (1/3);
            skillBreakdown.burn = val;
            fullSkillDps += val;
            skillBreakdown._burnLabel = ' 燃烧 DOT ' + labelSuffix;
            
            if (isEq('sixtail')) {
                let exVal = finalAtk * (ratios.foxExplode / 100) * explodeStacks * snowbearMult * explodeFreq;
                skillBreakdown.explode = exVal;
                fullSkillDps += exVal;
                skillBreakdown._explodeLabel = ` 六尾妖狐-爆燃 (每次${explodeStacks.toFixed(1)}层)`;
            }
        }
        
        if (isEq('twotail')) {
            let val = finalAtk * (ratios.ignite / 100) * snowbearMult * totalIgniteTriggers;
            skillBreakdown.ignite = val;
            fullSkillDps += val;
        }
        
        if (isEq('qihao')) {
            let qFreq = 1 / (60 / (1 + finalIceRate));
            let val = finalAtk * (ratios.qihao / 100) * snowbearMult * zuoguiMult * qFreq;
            skillBreakdown.qihao = val;
            fullSkillDps += val;
        }

        let currentTotalDps = fullSwingDps + fullSkillDps; 

        // --- 5. 伤害拆解 ---
        let val_snowbear = 0;
        let val_flat = 0;
        let val_buff = 0;
        let val_base = 0;

        // A. 剥离雪地熊
        if (snowbearMult > 1.0) {
            val_snowbear = currentTotalDps * (1 - 1/snowbearMult);
            fullSwingDps /= snowbearMult;
            for (let k in skillBreakdown) {
                if(!k.startsWith('_')) skillBreakdown[k] /= snowbearMult;
            }
        }
        let dpsWithoutSnow = currentTotalDps - val_snowbear;

        // B. 剥离白字
        const flatAtkGainValue = dpsWithoutSnow * flatAtkContributionRatio; // 总伤害中归功于白字的部分
        
        if (showFlatBreakdown && flatAtkContributionRatio > 0) {
            val_flat = flatAtkGainValue;
            fullSwingDps *= (1 - flatAtkContributionRatio);
            for (let k in skillBreakdown) {
                if(!k.startsWith('_')) skillBreakdown[k] *= (1 - flatAtkContributionRatio);
            }
        }

        // C. 剥离攻击百分比 (剩余的平砍部分拆分)
        // 固有伤害 (Base) vs 百分比收益 (Buff)
        let buffLabel = ' 攻击力百分比收益';
        if (cardAtkPct > 0) {
            // fullSwingDps 现在是: Base * (1+ExtraPct+CardPct) * (1-FlatRatio if removed)
            // 我们要拆出 CardPct 的贡献
            // 比例 = CardPct / (1 + ExtraPct + CardPct)
            const ratioBuff = cardAtkPct / (100 + extraPct + cardAtkPct);
            val_buff = fullSwingDps * ratioBuff;
            
            const absAtkGain = realBaseAtk * (cardAtkPct / 100);
            buffLabel = ` 攻击力百分比收益 (↑${cardAtkPct.toFixed(1)}% / <span style="color:#f1c40f">+${Math.round(absAtkGain)}</span>)`;
        }

        val_base = fullSwingDps - val_buff;

        // --- 6. 组装 ---
        let breakdownList = [];
        let baseLabel = useDilution ? ' 玩家固有 (含稀释)' : ' 玩家固有伤害';
        if (isEq('snowbear') && finalIceRate > 0) baseLabel += snowbearLabel;

        breakdownList.push({ id:'base', label: baseLabel, val: val_base, freq:0 });
        
        if (cardAtkPct > 0 || val_buff > 1) { 
            breakdownList.push({ id:'buff', label: buffLabel, val: val_buff, freq:0 });
        }

        if (showFlatBreakdown) {
            breakdownList.push({ id:'flat', label:' 丹青白字核心提升', val: val_flat, freq:0 });
        }

        if(skillBreakdown.ice > 0) breakdownList.push({ id:'ice', label:' 冰箭', val: skillBreakdown.ice, freq: finalIceRate });
        if(skillBreakdown.pulse > 0) breakdownList.push({ id:'pulse', label:' 脉冲', val: skillBreakdown.pulse, freq: pulseHitRate });
        if(skillBreakdown.burn > 0) breakdownList.push({ id:'burn', label: skillBreakdown._burnLabel, val: skillBreakdown.burn, freq: 0.3333 });
        if(skillBreakdown.ignite > 0) breakdownList.push({ id:'ignite', label:' 二尾妖狐-引燃', val: skillBreakdown.ignite, freq: totalIgniteTriggers });
        if(skillBreakdown.explode > 0) breakdownList.push({ id:'explode', label: skillBreakdown._explodeLabel, val: skillBreakdown.explode, freq: explodeFreq });
        if(skillBreakdown.qihao > 0) breakdownList.push({ id:'qihao', label:' 齐昊-玄冰风暴', val: skillBreakdown.qihao, freq: 1/(60/(1+finalIceRate)) });

        if (val_snowbear > 0) {
            breakdownList.push({ id:'snowbear', label: snowbearLabel, val: val_snowbear, freq: 0 });
        }

        // --- 7. 渲染 UI ---
        const baselineDps = userInputAtk > 0 ? (userBaseDps * (userInputAtk+extraFlat)/userInputAtk * (1+extraPct/100)) : 0;
        const cardSystemDps = currentTotalDps - baselineDps;

        document.getElementById('currCost').innerText = costSum;
        document.getElementById('res-flatAtk').innerText = Math.round(cardTotalFlatAtk);
        document.getElementById('res-finalAtk').innerText = Math.round(finalAtk);
        document.getElementById('res-totalDps').innerText = Math.round(currentTotalDps).toLocaleString();
        document.getElementById('res-cardSystemDps').innerText = Math.round(cardSystemDps).toLocaleString();

        const inc = baselineDps > 0 ? ((currentTotalDps - baselineDps)/baselineDps * 100) : 0;
        document.getElementById('res-percent').innerText = `+${inc.toFixed(1)}%`;

        const dpsListEl = document.getElementById('dps-list');
        let sortedList = breakdownList.sort((a, b) => dpsSortDir === 'desc' ? b.val - a.val : a.val - b.val);

        const fmtFreq = (f) => {
            if (f <= 0) return '-';
            if (freqMode === 'rate') return f < 0.01 ? '<0.01Hz' : f.toFixed(2) + 'Hz';
            const period = 1/f;
            return period < 0.1 ? '<0.1s' : period.toFixed(2) + 's';
        };

        let html = sortedList.map(obj => {
            if (obj.val <= 0 && obj.freq <= 0 && obj.id !== 'base') return '';
            const pct = currentTotalDps > 0 ? (obj.val / currentTotalDps * 100).toFixed(1) : '0.0';
            const freqStr = obj.freq > 0 ? fmtFreq(obj.freq) : '-';
            
            let color = '#fff'; 
            if(obj.id==='ice') color='#3498db'; 
            if(obj.id==='burn') color='#e74c3c';
            if(obj.id==='pulse') color='#2ecc71'; 
            if(obj.id==='ignite') color='#d35400';
            if(obj.id==='explode') color='#e67e22'; 
            if(obj.id==='qihao') color='#9b59b6';
            if(obj.id==='buff') color='#7f8c8d'; 
            if(obj.id==='flat') color='#00d2d3'; 
            if(obj.id==='snowbear') color='#ff9ff3';

            return `
            <div class="breakdown-row">
                <div class="col-name"><span style="color:${color}">●</span> ${obj.label}</div>
                <div class="col-freq">${freqStr}</div>
                <div class="col-val" style="color:${color}">${Math.round(obj.val).toLocaleString()}</div>
                <div class="col-pct">${pct}%</div>
            </div>`;
        }).join('');
        
        dpsListEl.innerHTML = html;
        
        const arrow = document.getElementById('sort-arrow');
        arrow.innerText = dpsSortDir === 'desc' ? '▼' : '▲';
        arrow.style.color = '#fff'; 
        
        updateExtraEffects(finalAtk);
    }

    function updateExtraEffects(currentAtk = 0) {
        const container = document.getElementById('extra-effects-box');
        const content = document.getElementById('extra-list-content');
        let html = '';
        
        const fmt = (n) => parseFloat(n.toFixed(2));
        const fmtAbs = (pct) => {
            if (!currentAtk) return '';
            const absVal = Math.round(currentAtk * pct / 100);
            return ` <span style="color:#7f8c8d; font-size:11px;">(<span style="color:#2ecc71">${absVal.toLocaleString()}</span>)</span>`;
        };

        const handlers = {
            'xiaohuan': (val) => `会心等级 +<span class="highlight">${fmt(val)}</span>`,
            'wilddog': (val) => `化伤与秽灭 +<span class="highlight">${fmt(val)}</span>`,
            'turtle': (val) => `专精等级 +<span class="highlight">${fmt(val)}</span>`,
            'kite': (val) => `调息等级 +<span class="highlight">${fmt(val)}</span>`,
            'threetail': (val) => `每层燃烧提供防御 +<span class="highlight">${fmt(val)}</span>`,
            'ghostdog': (val) => `受击引燃 (内置冷却 <span class="highlight">${fmt(val)}</span> 秒)`,
            'zuogui': (val) => `气血恢复效果提高 <span class="highlight">${fmt(val)}%</span>`,
            'pearl': (val) => `脉冲使气血恢复提高 <span class="highlight">${fmt(val)}%</span>`,
            'hehuanbell': (val) => `受击回复 <span class="highlight">${fmt(val)}%</span>${fmtAbs(val)} 攻击力的气血`,
            'fan': (val, lv) => {
                const heal = 4.8 + (1.2 * lv / 6);
                return `脉冲治疗队友 <span class="highlight">${fmt(heal)}%</span>${fmtAbs(heal)}`;
            },
            'dice': (val, lv) => {
                const heal = 9.0 + (3.0 * lv / 6);
                return `脉冲额外气血恢复 <span class="highlight">${fmt(heal)}%</span>${fmtAbs(heal)}`;
            }
        };

        DB.forEach(c => {
            if (isEq(c.id) && handlers[c.id]) {
                const val = getStatVal(c.id);
                const lv = state[c.id].level;
                const text = handlers[c.id](val, lv);
                
                html += `
                <div class="extra-row">
                    <span class="extra-name">● ${c.name}</span>
                    <span class="extra-val">${text}</span>
                </div>`;
            }
        });

        content.innerHTML = html;
        if (html === '') container.classList.add('hidden');
        else container.classList.remove('hidden');
    }

    // ==========================================
    // 3. 界面交互
    // ==========================================
    
    function makeDots(id, currentLv, isGlobal=false) {
        let html = '';
        for (let i = 1; i <= 6; i++) {
            const isActive = i <= currentLv;
            const clickFn = isGlobal ? `setGlobalLevel(${i})` : `setLevel('${id}', ${i})`;
            html += `<div class="dot ${isActive ? 'active' : ''}" onclick="${clickFn}; event.stopPropagation();"></div>`;
        }
        return html;
    }

    function toggleClickMode() {
        isFastMode = !isFastMode;
        const btn = document.getElementById('modeBtn');
        btn.innerText = isFastMode ? "模式: 单击装备" : "模式: 双击装备";
        renderList();
    }

    function toggleSortMode() {
        cardSortMode = cardSortMode === 'type' ? 'cost' : 'type';
        const btn = document.getElementById('sortBtn');
        btn.innerText = cardSortMode === 'type' ? "排序: 按类别" : "排序: 按费用";
        renderList();
    }
    
    function handleFastClick(id) {
        showDetail(id);
        toggleCard(id);
    }

    function renderList() {
        const container = document.getElementById('cardList');
        let displayList = [...DB];
        
        displayList.sort((a, b) => {
            const typeMap = { human: 1, beast: 2, tool: 3 };
            if (cardSortMode === 'type') {
                if (typeMap[a.type] !== typeMap[b.type]) return typeMap[a.type] - typeMap[b.type];
                return a.cost - b.cost;
            } else {
                if (a.cost !== b.cost) return a.cost - b.cost;
                return typeMap[a.type] - typeMap[b.type];
            }
        });

        container.innerHTML = displayList.map(c => {
            const eventStr = isFastMode 
                ? `onclick="handleFastClick('${c.id}')"` 
                : `onclick="showDetail('${c.id}')" ondblclick="toggleCard('${c.id}')"`;

            return `
            <div class="card-item ${state[c.id].equipped ? 'equipped' : ''}" id="row-${c.id}" ${eventStr}>
                <div class="card-meta">
                    <span class="card-type type-${c.type}">${c.type==='human'?'人':c.type==='beast'?'兽':'器'}</span>
                    <span class="card-name">${c.name}</span>
                    <span class="card-cost">${c.cost}C</span>
                </div>
                <div class="dots-wrapper">
                    ${makeDots(c.id, state[c.id].level)}
                </div>
            </div>
        `}).join('');
        
        document.getElementById('global-dots').innerHTML = makeDots('global', globalLvState, true);
        calc();
    }

    function toggleCard(id) { state[id].equipped = !state[id].equipped; renderList(); }
    function setLevel(id, lv) { state[id].level = (state[id].level === lv) ? 0 : lv; renderList(); if (currDetail === id) showDetail(id); }
    function setGlobalLevel(lv) { globalLvState = (globalLvState === lv) ? 0 : lv; DB.forEach(c => state[c.id].level = globalLvState); renderList(); if (currDetail) showDetail(currDetail); }
    function clearAll() { DB.forEach(c => state[c.id].equipped = false); renderList(); }
    function toggleSort() { dpsSortDir = dpsSortDir === 'desc' ? 'asc' : 'desc'; calc(); }
    function toggleFreqMode() { freqMode = freqMode === 'interval' ? 'rate' : 'interval'; document.getElementById('header-freq-text').innerText = freqMode === 'interval' ? '触发间隔' : '触发频率'; calc(); }

    let currDetail = null;
    function showDetail(id) {
        currDetail = id;
        renderList(); 
        const c = DB.find(x => x.id === id);
        let val = getStatVal(id);
        const lv = state[id].level;
        
        const fmt = (n) => parseFloat(n.toFixed(2));
        const fmtAbs = (pct) => {
            if (!g_finalAtk || pct === 0) return '';
            const absVal = Math.round(g_finalAtk * pct / 100);
            return `<span style="color:#7f8c8d; font-size:12px; font-weight:normal;"> (${absVal})</span>`;
        };
        const replaceSmart = (text, tag, value, showAbs) => {
            const valHtml = `<span class="highlight">${fmt(value)}</span>`;
            const absHtml = showAbs ? fmtAbs(value) : '';
            if (text.includes(tag + '%')) return text.replace(tag + '%', valHtml + '%' + absHtml);
            return text.replace(tag, valHtml + absHtml);
        };

        let desc = c.desc;
        if (id === 'linfeng') {
            const iceChance = 70 + ((100-70)/6 * lv);
            desc = desc.replace('{val}', `<span class="highlight">${fmt(val)}</span>`).replace('{ice}', `<span class="highlight">${fmt(iceChance)}</span>`);
        } else if (id === 'fan' || id === 'dice') { 
            const healVal = id==='fan' ? 4.8+(1.2*lv/6) : 9.0+(3.0*lv/6);
            desc = replaceSmart(desc, '{val}', val, true);
            desc = replaceSmart(desc, '{heal}', healVal, true);
        } else if (id === 'snowbear') {
            desc = replaceSmart(desc, '{val}', val, false);
        } else {
            const showAbs = ['yanhong', 'redant', 'twotail', 'sixtail', 'qihao', 'mirror', 'hehuanbell'].includes(id);
            desc = replaceSmart(desc, '{val}', val, showAbs);
            desc = desc.replace('{freq}', `<span class="highlight">${fmt(val)}</span>`);
        }
        document.getElementById('detail-content').innerHTML = `<div class="detail-title">${c.name} <span style="font-size:12px; color:#999; font-weight:normal;">(Lv.${state[id].level})</span></div><div class="detail-desc">${desc}</div>`;
    }

    renderList();
</script>

</body>
</html>