<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>诛仙丹青Build计算器</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root { 
            --primary: #3498db; 
            --bg: #f5f6fa; 
            --dark: #2c3e50; 
            --panel: #ffffff; 
            --gray: #bdc3c7; 
            --card-blue: #3498db; 
            --card-red: #e74c3c;
            --card-green: #27ae60;
        }
        body { font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background: var(--bg); color: var(--dark); margin: 0; padding: 20px; display: flex; justify-content: center; height: 100vh; box-sizing: border-box; overflow: hidden; }
        
        .layout { display: flex; width: 100%; max-width: 1600px; gap: 20px; height: 100%; }
        
        /* --- 左侧面板 --- */
        .card-list-panel { flex: 0 0 720px; display: flex; flex-direction: column; background: var(--panel); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); overflow: hidden; }
        
        .list-header { 
            padding: 15px 20px; background: #ecf0f1; border-bottom: 1px solid #bdc3c7; 
            display: flex; justify-content: space-between; align-items: center; user-select: none; 
        }
        
        .header-left-group { display: flex; align-items: center; gap: 15px; }
        .header-title { font-weight: bold; font-size: 18px; color: var(--dark); }
        .global-ctrl { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #7f8c8d; }
        
        /* 按钮组样式 */
        .header-btn-group { display: flex; gap: 10px; }

        .clear-btn { 
            font-size: 12px; cursor: pointer; color: #fff; background: #e74c3c; 
            border: none; padding: 6px 15px; border-radius: 4px; 
            transition: all 0.2s; font-weight: bold;
        }
        .clear-btn:hover { background: #c0392b; box-shadow: 0 2px 5px rgba(231, 76, 60, 0.3); }

        /* 通用功能按钮样式 (排序 & 模式) */
        .ctrl-btn {
            font-size: 12px; cursor: pointer; color: #fff; background: #3498db; 
            border: none; padding: 6px 15px; border-radius: 4px; 
            transition: all 0.2s; font-weight: bold; min-width: 80px;
        }
        .ctrl-btn:hover { background: #2980b9; box-shadow: 0 2px 5px rgba(52, 152, 219, 0.3); }

        /* 卡牌滚动区 (3列) */
        .scroll-area { 
            flex: 1; overflow-y: auto; padding: 15px; 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 12px; 
            align-content: start;
        }
        
        /* 卡牌单元格 */
        .card-item { 
            background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; 
            cursor: pointer; transition: all 0.1s; user-select: none;
            display: flex; flex-direction: column; justify-content: center;
            height: 72px; 
            padding: 0 12px; position: relative; gap: 8px;
        }
        .card-item:hover { border-color: #bdc3c7; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.08); }
        .card-item.equipped { 
            background: #eef9fe; 
            border-color: #3498db; 
            box-shadow: 0 0 0 1px #3498db inset; 
        }
        
        /* 卡牌内容 */
        .card-meta { display: flex; align-items: center; gap: 6px; }
        .card-name { font-weight: 700; font-size: 15px; color: #333; white-space: nowrap; }
        
        /* 费用标签样式：白底黑字 + 灰色边框 */
        .card-cost { 
            background: #fff; 
            color: #333; 
            border: 1px solid #bdc3c7; /* 加个边框防止看不清 */
            font-size: 11px; padding: 2px 5px; border-radius: 3px; font-weight: bold; min-width: 14px; text-align: center;
        }
    
        .card-type { font-size: 10px; padding: 2px 4px; border-radius: 3px; color: white;}
        .type-human { background-color: var(--card-blue); }
        .type-beast { background-color: var(--card-red); }
        .type-tool { background-color: var(--card-green); }

        /* 等级圆点 */
        .dots-wrapper { display: flex; gap: 6px; align-items: center; }
        .dot { 
            width: 12px; height: 12px; 
            border-radius: 50%; background: #e0e0e0; cursor: pointer; transition: all 0.2s; border: 1px solid transparent; 
        }
        .dot:hover { transform: scale(1.2); border-color: #f1c40f; background: #ccc; }
        .dot.active { background: #f1c40f; box-shadow: 0 0 2px rgba(241, 196, 15, 0.6); }


        /* --- 右侧面板 --- */
        .right-panel { flex: 1; display: flex; flex-direction: column; gap: 15px; min-width: 0; }
        
        .detail-card { background: var(--panel); padding: 15px 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); min-height: 80px; }
        .detail-title { font-size: 18px; font-weight: bold; margin-bottom: 5px; color: var(--dark); border-bottom: 2px solid var(--primary); padding-bottom: 5px; display: inline-block;}
        .detail-desc { font-size: 14px; line-height: 1.6; color: #555; }
        .highlight { color: #e74c3c; font-weight: bold; }
        
        /* 仪表盘 */
        .dashboard { flex: 1; background: var(--dark); color: white; border-radius: 12px; padding: 20px; display: flex; flex-direction: column; overflow-y: auto; }
        
        /* 输入控件区 */
        .controls-area { margin-bottom: 15px; display: flex; flex-direction: column; gap: 10px; }

        /* 选项行 */
        .options-row { display: flex; gap: 20px; font-size: 12px; color: #bdc3c7; align-items: center; }
        .chk-label { display: flex; align-items: center; gap: 5px; cursor: pointer; user-select: none; }
        .chk-label input { cursor: pointer; }

        /* 统一的单行数据栏 */
        .unified-row { 
            display: flex; justify-content: space-between; align-items: center; 
            background: rgba(255,255,255,0.08); padding: 15px 20px; border-radius: 8px; 
            margin-bottom: 5px;
        }

        .left-group { display: flex; gap: 15px; align-items: center; }
        .right-group { display: flex; gap: 30px; align-items: center; border-left: 1px solid rgba(255,255,255,0.1); padding-left: 20px;}

        .inp-item { display: flex; flex-direction: column; gap: 5px; }
        .inp-item label { font-size: 12px; color: #95a5a6; font-weight: bold; white-space: nowrap; }
        .inp-item input { 
            background: rgba(0,0,0,0.3); border: 1px solid #555; color: white; 
            padding: 6px; border-radius: 4px; width: 90px; text-align: center; font-weight: bold; font-size: 14px;
        }
        .inp-item input:focus { border-color: var(--primary); outline: none; background: rgba(0,0,0,0.5); }
        
        /* 去掉输入框的上下箭头 */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* 统计数值样式 */
        .stat-box { display: flex; flex-direction: column; align-items: flex-end; }
        .stat-label { font-size: 12px; color: #7f8c8d; margin-bottom: 2px; }
        .stat-val { font-size: 20px; font-weight: bold; line-height: 1.2;}

        /* 隐藏类 */
        .hidden { display: none !important; }

        /* 伤害明细表 */
        .dps-breakdown { background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-top: 10px; flex: 1; overflow-y: auto; }
        
        .breakdown-header { display: flex; padding: 8px 0; border-bottom: 1px solid #7f8c8d; font-size: 12px; color: #bdc3c7; font-weight: bold; user-select: none; }
        .col-name { flex: 2; padding-left: 5px; }
        .col-freq { flex: 1.2; text-align: center; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px; transition: color 0.2s;}
        .col-freq:hover { color: white; }
        .col-val { flex: 1.5; text-align: right; cursor: pointer; display: flex; align-items: center; justify-content: flex-end; gap: 4px; transition: color 0.2s;}
        .col-val:hover { color: white; }
        .col-pct { flex: 0.8; text-align: right; }
        
        .breakdown-row { display: flex; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 13px; align-items: center; }
        .breakdown-row:last-child { border-bottom: none; }
        .breakdown-row:hover { background: rgba(255,255,255,0.05); }

        /* 最终结果栏 */
        .final-result { 
            margin-top: auto; padding-top: 20px; 
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; 
        }
        .res-card { 
            background: rgba(255,255,255,0.08); border-radius: 8px; padding: 10px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .res-card-label { font-size: 12px; color: #bdc3c7; margin-bottom: 5px; }
        .res-card-val { font-size: 22px; font-weight: bold; }
        
        .c-total { color: #f1c40f; }
        .c-system { color: #3498db; }
        .c-inc { color: #2ecc71; }
        
        .sort-arrow { font-size: 10px; opacity: 0.5; }

        /* =========================================
           移动端适配 (响应式布局)
           当屏幕宽度小于 1024px 时生效
           ========================================= */
        @media screen and (max-width: 1024px) {
            body {
                /* 取消固定高度，允许页面在手机上上下滚动 */
                height: auto;
                overflow-y: auto; 
                -webkit-overflow-scrolling: touch;
            }

            .layout {
                /* 关键：从左右排列(row)改为上下排列(column) */
                flex-direction: column;
                height: auto;
            }

            /* 左侧面板适配 */
            .card-list-panel {
                flex: none; /* 取消固定宽度限制 */
                width: 100%; /* 占满屏幕宽度 */
                height: auto;
                max-height: 500px; /* 给列表一个最大高度，防止太长 */
                margin-bottom: 20px; /* 与下方内容保持间距 */
            }

            .scroll-area {
                /* 手机上保持列表内部滚动，但不占满全屏 */
                height: 300px; 
                overflow-y: auto;
            }

            /* 右侧面板适配 */
            .right-panel {
                width: 100%;
                flex: none;
            }

            /* 控制区适配：变成多行显示，防止挤压 */
            .unified-row {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }

            .left-group, .right-group {
                width: 100%;
                justify-content: space-between;
                border-left: none; /* 去掉原本的分割线 */
                padding-left: 0;
            }
            
            .right-group {
                border-top: 1px solid rgba(255,255,255,0.1); /* 改为上方分割线 */
                padding-top: 15px;
            }

            /* 底部结果卡片适配：手机上一行显示一个或两个 */
            .final-result {
                grid-template-columns: 1fr; /* 一行一个 */
                gap: 10px;
            }
            
            /* 调整字体大小，防止手机上字太大撑破布局 */
            .stat-val { font-size: 18px; }
            .card-item { height: auto; padding: 10px; } /* 卡片高度自适应 */
        }
        
    </style>
</head>
<body>

<div class="layout">
    <div class="card-list-panel">
        <div class="list-header">
            <div class="header-left-group">
                <span class="header-title">丹青配置</span>
                <div class="global-ctrl">
                    <span>一键调整:</span>
                    <div class="dots-wrapper" id="global-dots"></div>
                </div>
            </div>
            
            <div class="header-btn-group">
                <button class="ctrl-btn" id="sortBtn" onclick="toggleSortMode()">排序: 按类别</button>
                <button class="ctrl-btn" id="modeBtn" onclick="toggleClickMode()">模式: 双击装备</button>
                <button class="clear-btn" onclick="clearAll()">清空选择</button>
            </div>
        </div>
        
        <div class="scroll-area" id="cardList"></div>
    </div>

    <div class="right-panel">
        
        <div class="detail-card">
            <div id="detail-content">
                <div style="color: #ccc; padding-top: 15px; text-align: center;">单击卡牌查看详情 / 双击装备或卸下</div>
            </div>
        </div>

        <div class="dashboard">
            <div class="controls-area">
                <div class="options-row">
                    <label class="chk-label">
                        <input type="checkbox" id="chk-showFlat" onchange="calc()" checked> 
                        独立显示丹青白字攻击提升占比
                    </label>
                    <label class="chk-label">
                        <input type="checkbox" id="chk-dilution" onchange="toggleDilution()"> 
                        考虑其他攻击力提升稀释
                    </label>
                </div>

                <div class="unified-row">
                    <div class="left-group">
                        <div class="inp-item">
                            <label>玩家攻击力</label>
                            <input type="number" id="baseAtk" value="10000" oninput="calc()">
                        </div>
                        <div class="inp-item">
                            <label>固有DPS</label>
                            <input type="number" id="baseDps" value="50000" oninput="calc()">
                        </div>
                        
                        <div class="inp-item hidden" id="dilution-pct-box">
                            <label style="color:#e67e22">其他攻击(%)</label>
                            <input type="number" id="extraPct" value="3" oninput="calc()" style="border-color:#e67e22">
                        </div>
                        <div class="inp-item hidden" id="dilution-flat-box">
                            <label style="color:#e67e22">其他白字</label>
                            <input type="number" id="extraFlat" value="0" oninput="calc()" style="border-color:#e67e22">
                        </div>
                    </div>

                    <div class="right-group">
                        <div class="stat-box">
                            <div class="stat-label">总 Cost 花费</div>
                            <div class="stat-val" style="color:#f1c40f;"><span id="currCost">0</span></div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">丹青白字攻击</div>
                            <div class="stat-val" style="color:#3498db;" id="res-flatAtk">0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">最终攻击力</div>
                            <div class="stat-val" style="color:#fff;" id="res-finalAtk">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="font-size:12px; color:#95a5a6;">伤害构成分析</div>
            </div>
            
            <div class="dps-breakdown">
                <div class="breakdown-header">
                    <div class="col-name">伤害来源</div>
                    
                    <div class="col-freq" onclick="toggleFreqMode()">
                        <span id="header-freq-text">触发间隔</span>
                        <span style="font-size:10px;">⇄</span>
                    </div>

                    <div class="col-val" onclick="toggleSort()">
                        <span>秒伤 (DPS)</span>
                        <span class="sort-arrow" id="sort-arrow">▼</span>
                    </div>
                    
                    <div class="col-pct">占比</div>
                </div>
                <div id="dps-list">
                    </div>
            </div>

            <div class="final-result">
                <div class="res-card">
                    <div class="res-card-label">总秒伤 (Total)</div>
                    <div class="res-card-val c-total" id="res-totalDps">0</div>
                </div>

                <div class="res-card">
                    <div class="res-card-label">丹青提供秒伤</div>
                    <div class="res-card-val c-system" id="res-cardSystemDps">0</div>
                </div>

                <div class="res-card">
                    <div class="res-card-label">丹青提供增幅</div>
                    <div class="res-card-val c-inc" id="res-percent">+0.0%</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // 1. 数据定义
    // ==========================================
    const Linear = (v0, v6) => ({ type: 'linear', v0, v6 });
    const Fixed = (v) => ({ type: 'fixed', val: v });

    const FLAT_ATK_V0 = 44.9;
    const FLAT_ATK_V6 = 58.2;

    const DB = [
        // --- 人族 ---
        { id: 'xiaohuan', name: '小环', type: 'human', cost: 1, desc: '会心提高{val}', stat: Linear(280, 400), effect: 'crit_flat' },
        { id: 'wilddog', name: '野狗道人', type: 'human', cost: 1, desc: '化伤和秽灭提高{val}', stat: Linear(56, 80), effect: 'none' },
        { id: 'yanhong', name: '燕虹', type: 'human', cost: 1, desc: '释放技能时，向目标发射一枚冰箭，造成{val}%固定伤害（6秒冷却）', stat: Linear(28, 40), effect: 'ice_base' },
        { id: 'zhou', name: '周一仙', type: 'human', cost: 2, desc: '每装备一张人族卡牌，物理和法术攻击力提高{val}%', stat: Linear(0.56, 0.80), effect: 'count_race_atk' },
        { id: 'wenmin', name: '文敏', type: 'human', cost: 2, desc: '战斗中每间隔{freq}秒，向目标发射3枚冰箭', stat: {v0: 16, v6: 10}, effect: 'ice_add_freq' },
        { id: 'shangguan', name: '上官策', type: 'human', cost: 2, desc: '冰箭有{val}%概率赋予目标1层燃烧', stat: Linear(38, 50), effect: 'ice_trigger_burn' },
        { id: 'linfeng', name: '林峰', type: 'human', cost: 3, desc: '附加燃烧效果时有{val}%概率额外叠加1层燃烧，召唤冰箭时有{ice}%概率额外召唤一枚冰箭', stat: Linear(42, 60), effect: 'linfeng_dual' },
        { id: 'zuogui', name: '左归', type: 'human', cost: 4, desc: '冰箭/玄冰风暴/燃烧/脉冲造成的伤害和气血恢复效果提高{val}%', stat: Linear(28, 40), effect: 'global_dmg_mult' },
        { id: 'qihao', name: '齐昊', type: 'human', cost: 5, desc: '召唤一只冰霜元素，向目标发射玄冰风暴，造成{val}%固定伤害，每间隔60秒仅可触发一次；每召唤一枚冰箭，冰霜元素的冷却时间缩短1秒', stat: Linear(1040, 1400), effect: 'qihao_nuke' }, // 描述更新

        // --- 兽族 ---
        { id: 'turtle', name: '海龟', type: 'beast', cost: 1, desc: '专精提高{val}', stat: Linear(280, 400), effect: 'mastery_flat' },
        { id: 'redant', name: '猩红巨蚁', type: 'beast', cost: 1, desc: '造成伤害时，引燃目标和目标周围的所有敌人，添加燃烧，每3秒造成{val}%固定伤害，持续18秒，燃烧最多可以叠加12层（8秒内置冷却）', stat: Linear(1.4, 2), effect: 'burn_base' },
        { id: 'tiger', name: '猛虎', type: 'beast', cost: 2, desc: '每装备一张兽族卡牌，物理和法术攻击力提高{val}%', stat: Linear(0.56, 0.80), effect: 'count_race_atk' },
        { id: 'twotail', name: '二尾妖狐', type: 'beast', cost: 2, desc: '当自身尝试为目标添加燃烧时，立刻对目标造成{val}%伤害', stat: Linear(28, 40), effect: 'burn_on_hit' },
        { id: 'ghostdog', name: '幽冥犬', type: 'beast', cost: 2, desc: '受到伤害时会引燃周围的敌人，对周围的所有敌人添加1层燃烧（{val}秒内置冷却）', stat: Linear(10, 4), effect: 'none' },
        { id: 'threetail', name: '三尾妖狐', type: 'beast', cost: 4, desc: '每个激活的燃烧使自身防御力提高{val}', stat: Linear(140, 200), effect: 'none' },
        { id: 'suishou', name: '岁兽', type: 'beast', cost: 3, desc: '脉冲命中敌人时，有{val}%概率为其添加3层燃烧效果', stat: Linear(70, 100), effect: 'pulse_trigger_burn' },
        { id: 'snowbear', name: '雪地熊', type: 'beast', cost: 4, desc: '召唤冰箭时，造成的伤害额外提高{val}%，持续10秒，可多次叠加，每层效果独立计算持续时间', stat: Linear(0.38, 0.5), effect: 'snowbear_buff' },
        { id: 'sixtail', name: '六尾魔狐', type: 'beast', cost: 5, desc: '燃烧叠加至8层以上时，触发爆燃：1.5秒后，引爆目标身上所有的燃烧效果，每引爆1层燃烧效果，对目标和目标周围的敌人造成{val}%伤害', stat: Linear(50, 68), effect: 'sixtail_explode' }, // 描述更新

        // --- 器族 ---
        { id: 'woodsword', name: '木剑', type: 'tool', cost: 1, desc: '主属性提高{val}%', stat: Linear(0.56, 0.80), effect: 'fixed_atk' },
        { id: 'kite', name: '风筝', type: 'tool', cost: 1, desc: '调息提高{val}', stat: Linear(280, 400), effect: 'haste_flat' },
        { id: 'fan', name: '折扇', type: 'tool', cost: 1, desc: '战斗每经过15秒，触发脉冲，对周围敌人造成{val}%伤害，为周围最多10名队友造成447治疗。承伤和输出职能造成的气血恢复效果降低50%。', stat: Linear(40, 52), effect: 'pulse_base' },
        { id: 'banner', name: '“仙人”布幡', type: 'tool', cost: 2, desc: '每装备一张器物卡牌，物理和法术攻击力提高{val}%', stat: Linear(0.56, 0.80), effect: 'count_race_atk' },
        { id: 'dice', name: '神木骰', type: 'tool', cost: 2, desc: '脉冲造成伤害或气血恢复效果时，在10秒内额外造成{val}伤害或837气血恢复，进入战斗时立刻触发3次脉冲。承伤和输出职能造成的气血恢复效果降低50%。', stat: Fixed(70), effect: 'dice_buff' },
        { id: 'bamboo', name: '寒冰剑', type: 'tool', cost: 3, desc: '召唤{freq}枚冰箭后，触发脉冲', stat: {v0: 16, v6: 10}, effect: 'ice_count_pulse' },
        { id: 'pearl', name: '清凉珠', type: 'tool', cost: 3, desc: '触发脉冲时，自身气血恢复效果提高{val}%，持续10秒。', stat: Linear(2.8, 4), effect: 'none' },
        { id: 'bell', name: '合欢铃', type: 'tool', cost: 4, desc: '气血低于30%时，受到伤害立刻恢复自身63193气血，但接下来的10秒内，自身总计受到3718伤害，此效果有120秒冷却', stat: Fixed(0), effect: 'none' }, // 新增
        { id: 'mirror', name: '六合镜', type: 'tool', cost: 5, desc: '触发脉冲时，有50%概率使自身获得回响效果，持续6秒。回响：每1秒以140%效率释放脉冲（触发4次140%伤害的脉冲），回响效果释放的脉冲无法附加脉冲造成的额外效果', stat: Linear(140, 200), effect: 'mirror_echo' },
    ];

    const state = {};
    DB.forEach(c => state[c.id] = { equipped: false, level: 0 });

    // UI State
    let dpsSortDir = 'desc'; 
    let freqMode = 'interval'; 
    let globalLvState = 0;
    
    // 点击模式与排序模式
    let isFastMode = false;
    let cardSortMode = 'type'; // 'type' | 'cost'

    // ==========================================
    // 2. 逻辑计算
    // ==========================================

    function getStatVal(cardId) {
        const card = DB.find(c => c.id === cardId);
        const lv = state[cardId].level;
        const s = card.stat;
        if (s.type === 'fixed') return s.val;
        const range = s.v6 - s.v0;
        return s.v0 + range * (lv / 6);
    }
    
    function getCardFlatAtk(cardId) {
        const c = DB.find(x => x.id === cardId);
        const lv = state[cardId].level;
        const range = FLAT_ATK_V6 - FLAT_ATK_V0;
        const baseFlat = FLAT_ATK_V0 + range * (lv / 6);
        return baseFlat * c.cost;
    }

    const isEq = (id) => state[id].equipped;

    function toggleDilution() {
        const checked = document.getElementById('chk-dilution').checked;
        const box1 = document.getElementById('dilution-pct-box');
        const box2 = document.getElementById('dilution-flat-box');
        if (checked) {
            box1.classList.remove('hidden');
            box2.classList.remove('hidden');
        } else {
            box1.classList.add('hidden');
            box2.classList.add('hidden');
        }
        calc();
    }

function calc() {
        // --- 0. 基础输入与选项读取 ---
        const userInputAtk = parseFloat(document.getElementById('baseAtk').value) || 0;
        const userBaseDps = parseFloat(document.getElementById('baseDps').value) || 0;
        
        const showFlatBreakdown = document.getElementById('chk-showFlat').checked;
        const useDilution = document.getElementById('chk-dilution').checked;

        let extraPct = 0; 
        let extraFlat = 0; 

        if (useDilution) {
            extraPct = parseFloat(document.getElementById('extraPct').value) || 0;
            extraFlat = parseFloat(document.getElementById('extraFlat').value) || 0;
        }

        // --- 1. 统计卡牌数据 ---
        let countHuman = 0, countBeast = 0, countTool = 0;
        let costSum = 0;
        let cardTotalFlatAtk = 0; 

        DB.forEach(c => {
            if (isEq(c.id)) {
                costSum += c.cost;
                if (c.type === 'human') countHuman++;
                if (c.type === 'beast') countBeast++;
                if (c.type === 'tool') countTool++;
                cardTotalFlatAtk += getCardFlatAtk(c.id);
            }
        });

        // 丹青提供的攻击力百分比 (CardPct)
        let cardAtkPct = 0;
        if (isEq('zhou')) cardAtkPct += getStatVal('zhou') * countHuman;
        if (isEq('tiger')) cardAtkPct += getStatVal('tiger') * countBeast;
        if (isEq('banner')) cardAtkPct += getStatVal('banner') * countTool;
        if (isEq('woodsword')) cardAtkPct += getStatVal('woodsword');

        // --- 2. 核心数值计算 ---
        const totalPct = extraPct + cardAtkPct; // 总百分比加成
        const realBaseAtk = userInputAtk + extraFlat + cardTotalFlatAtk; // 总基础面板(含白字)
        const finalAtk = realBaseAtk * (1 + totalPct/100); // 最终攻击力

        // --- 3. 丹青特效参数计算 ---
        const ratios = {
            ice: getStatVal('yanhong'), burn: getStatVal('redant'), pulse: getStatVal('fan'),
            qihao: getStatVal('qihao'), foxExplode: getStatVal('sixtail'), ignite: getStatVal('twotail'),
            mirror: getStatVal('mirror'), dice: getStatVal('dice'), suishouChance: getStatVal('suishou')
        };

        let globalMult = 1.0;
        if (isEq('zuogui')) globalMult += (getStatVal('zuogui') / 100);

        // 林峰 & 频率
        let linfengIceChance = 0, linfengBurnChance = 0;
        if (isEq('linfeng')) {
            linfengBurnChance = getStatVal('linfeng') / 100;
            linfengIceChance = 0.7 + ((1.0 - 0.7)/6 * state['linfeng'].level);
        }

        let rawIceRate = 0; 
        if (isEq('yanhong')) rawIceRate += (1/6);
        if (isEq('wenmin')) rawIceRate += (3 / getStatVal('wenmin'));
        let finalIceRate = rawIceRate * (1 + linfengIceChance);

        let pulseRate = 0;
        if (isEq('fan')) pulseRate += (1/15);
        if (isEq('bamboo') && finalIceRate > 0) pulseRate += (finalIceRate / getStatVal('bamboo'));
        let pulseHitRate = pulseRate; 

        let eventRedant = isEq('redant') ? (1/8) : 0;
        let eventShangguan = isEq('shangguan') ? (finalIceRate * getStatVal('shangguan')/100) : 0;
        let eventSuishou = 0;
        if (isEq('suishou')) eventSuishou = (pulseHitRate * (ratios.suishouChance / 100)) * 3;
        
        let totalIgniteTriggers = (eventRedant + eventShangguan + eventSuishou) * (1 + linfengBurnChance);
        let finalStackRate = totalIgniteTriggers; 

        // --- 4. 伤害计算与拆分 ---

        // 4.1 六尾引爆频率修正 (1.5s 延迟机制)
        let explodeFreq = 0;
        let explodeStacks = 0; 

        if (isEq('sixtail') && finalStackRate > 0) {
            // A. 叠满8层所需时间
            const timeTo8 = 8 / finalStackRate;
            // B. 1.5秒延迟期间额外叠加的层数
            const extraStacks = finalStackRate * 1.5;
            // C. 最终引爆层数 (上限12层)
            explodeStacks = Math.min(12, 8 + extraStacks);
            // D. 完整循环周期
            const cycleTime = timeTo8 + 1.5;
            // E. 最终频率
            explodeFreq = 1 / cycleTime;
        }

        // 4.2 计算全状态下的各项完整DPS (Full DPS)
        const fullSwingDps = userInputAtk > 0 ? (userBaseDps * finalAtk / userInputAtk) : 0;

        let skillBreakdown = { ice:0, pulse:0, burn:0, ignite:0, explode:0, qihao:0 };
        let fullSkillDps = 0;

        if (finalIceRate > 0) {
            skillBreakdown.ice = finalAtk * (ratios.ice / 100) * globalMult * finalIceRate;
            fullSkillDps += skillBreakdown.ice;
        }
        if (pulseHitRate > 0) {
            let val = finalAtk * ((ratios.pulse + (isEq('dice')?ratios.dice:0)) / 100) * globalMult * pulseHitRate;
            if (isEq('mirror')) val += finalAtk * (ratios.mirror / 100) * globalMult * pulseHitRate * 0.5 * 4;
            skillBreakdown.pulse = val;
            fullSkillDps += val;
        }
        if (finalStackRate > 0) {
            let avgStacks = 12;
            let labelSuffix = '(12层)';
            
            if (isEq('sixtail')) {
                // 有六尾时，动态估算平均层数 (约为引爆层数的55%)
                avgStacks = explodeStacks * 0.55; 
                labelSuffix = `(动态均值${avgStacks.toFixed(1)}层)`;
            }
            
            // 燃烧DOT
            let val = finalAtk * (ratios.burn / 100) * avgStacks * globalMult * (1/3);
            skillBreakdown.burn = val;
            fullSkillDps += val;
            // 这里我们存一下label信息以便后续使用
            skillBreakdown._burnLabel = ' 燃烧 DOT ' + labelSuffix;
            
            // 六尾引爆
            if (isEq('sixtail')) {
                let exVal = finalAtk * (ratios.foxExplode / 100) * explodeStacks * globalMult * explodeFreq;
                skillBreakdown.explode = exVal;
                fullSkillDps += exVal;
                skillBreakdown._explodeLabel = ` 六尾妖狐-爆燃 (每次${explodeStacks.toFixed(1)}层)`;
            }
        }
        if (isEq('twotail')) {
            let val = finalAtk * (ratios.ignite / 100) * globalMult * totalIgniteTriggers;
            skillBreakdown.ignite = val;
            fullSkillDps += val;
        }
        if (isEq('qihao')) {
            let qFreq = 1 / (60 / (1 + finalIceRate));
            let val = finalAtk * (ratios.qihao / 100) * globalMult * qFreq;
            skillBreakdown.qihao = val;
            fullSkillDps += val;
        }

        const totalDps = fullSwingDps + fullSkillDps;

        // 4.3 计算归属比例
        // 丹青白字贡献比例
        const flatRatio = finalAtk > 0 ? (cardTotalFlatAtk * (1 + totalPct/100) / finalAtk) : 0;

        // --- 5. 组装 Breakdown 数据 ---
        let breakdownList = [];

        // 准备数值
        let val_flat = 0;
        let val_buff = 0;
        let val_base = 0;
        
        // 步骤 A: 计算 "攻击力百分比收益" (Buff)
        if (cardAtkPct > 0) {
            val_buff = fullSwingDps * (1 - (1 + extraPct/100)/(1 + totalPct/100));
        } else {
            val_buff = 0;
        }

        // 步骤 B: 计算 "平砍(Base)"
        val_base = fullSwingDps - val_buff;

        // 步骤 C: 处理 "丹青白字 (Flat)" 的剥离
        if (showFlatBreakdown && flatRatio > 0) {
            val_flat = totalDps * flatRatio;

            // 扣除白字占比
            val_base *= (1 - flatRatio);
            val_buff *= (1 - flatRatio);
            
            for (let k in skillBreakdown) {
                if(k.startsWith('_')) continue; // 跳过label字段
                skillBreakdown[k] *= (1 - flatRatio);
            }
        } else {
            val_flat = 0;
        }

        // 组装列表
        breakdownList.push({ id:'base', label: useDilution?' 玩家固有 (含稀释)':' 玩家固有伤害', val: val_base, freq:0 });
        
        if (cardAtkPct > 0 || val_buff > 1) { 
            breakdownList.push({ id:'buff', label:' 攻击力百分比收益', val: val_buff, freq:0 });
        }

        if (showFlatBreakdown) {
            breakdownList.push({ id:'flat', label:' 丹青白字核心提升', val: val_flat, freq:0 });
        }

        // 技能行
        if(skillBreakdown.ice > 0) breakdownList.push({ id:'ice', label:' 冰箭', val: skillBreakdown.ice, freq: finalIceRate });
        if(skillBreakdown.pulse > 0) breakdownList.push({ id:'pulse', label:' 脉冲', val: skillBreakdown.pulse, freq: pulseHitRate });
        if(skillBreakdown.burn > 0) breakdownList.push({ id:'burn', label: skillBreakdown._burnLabel, val: skillBreakdown.burn, freq: 0.3333 });
        if(skillBreakdown.ignite > 0) breakdownList.push({ id:'ignite', label:' 二尾妖狐-引燃', val: skillBreakdown.ignite, freq: totalIgniteTriggers });
        if(skillBreakdown.explode > 0) breakdownList.push({ id:'explode', label: skillBreakdown._explodeLabel, val: skillBreakdown.explode, freq: explodeFreq });
        if(skillBreakdown.qihao > 0) breakdownList.push({ id:'qihao', label:' 齐昊-玄冰风暴', val: skillBreakdown.qihao, freq: 1/(60/(1+finalIceRate)) });


        // --- 6. 渲染 UI ---
        const baselineDps = userInputAtk > 0 ? (userBaseDps * (userInputAtk+extraFlat)/userInputAtk * (1+extraPct/100)) : 0;
        const cardSystemDps = totalDps - baselineDps;

        document.getElementById('currCost').innerText = costSum;
        document.getElementById('res-flatAtk').innerText = Math.round(cardTotalFlatAtk);
        document.getElementById('res-finalAtk').innerText = Math.round(finalAtk);
        document.getElementById('res-totalDps').innerText = Math.round(totalDps).toLocaleString();
        document.getElementById('res-cardSystemDps').innerText = Math.round(cardSystemDps).toLocaleString();

        const inc = baselineDps > 0 ? ((totalDps - baselineDps)/baselineDps * 100) : 0;
        document.getElementById('res-percent').innerText = `+${inc.toFixed(1)}%`;

        // 列表排序与HTML生成
        const dpsListEl = document.getElementById('dps-list');
        let sortedList = breakdownList.sort((a, b) => dpsSortDir === 'desc' ? b.val - a.val : a.val - b.val);

        const fmtFreq = (f) => {
            if (f <= 0) return '-';
            if (freqMode === 'rate') return f < 0.01 ? '<0.01Hz' : f.toFixed(2) + 'Hz';
            const period = 1/f;
            return period < 0.1 ? '<0.1s' : period.toFixed(2) + 's';
        };

        let html = sortedList.map(obj => {
            if (obj.val <= 0 && obj.freq <= 0 && obj.id !== 'base') return '';
            const pct = totalDps > 0 ? (obj.val / totalDps * 100).toFixed(1) : '0.0';
            const freqStr = obj.freq > 0 ? fmtFreq(obj.freq) : '-';
            
            let color = '#fff'; // 默认为白色 (修复Base为灰色的问题)
            if(obj.id==='ice') color='#3498db'; 
            if(obj.id==='burn') color='#e74c3c';
            if(obj.id==='pulse') color='#2ecc71'; 
            if(obj.id==='ignite') color='#d35400';
            if(obj.id==='explode') color='#e67e22'; 
            if(obj.id==='qihao') color='#9b59b6';
            if(obj.id==='buff') color='#7f8c8d'; // 仅Buff为灰色
            if(obj.id==='flat') color='#00d2d3'; 

            return `
            <div class="breakdown-row">
                <div class="col-name"><span style="color:${color}">●</span> ${obj.label}</div>
                <div class="col-freq">${freqStr}</div>
                <div class="col-val" style="color:${color}">${Math.round(obj.val).toLocaleString()}</div>
                <div class="col-pct">${pct}%</div>
            </div>`;
        }).join('');
        
        dpsListEl.innerHTML = html;
        
        const arrow = document.getElementById('sort-arrow');
        arrow.innerText = dpsSortDir === 'desc' ? '▼' : '▲';
        arrow.style.color = '#fff'; // 修复箭头为白色
    }
    // ==========================================
    // 3. 界面交互
    // ==========================================
    
    function makeDots(id, currentLv, isGlobal=false) {
        let html = '';
        for (let i = 1; i <= 6; i++) {
            const isActive = i <= currentLv;
            const clickFn = isGlobal ? `setGlobalLevel(${i})` : `setLevel('${id}', ${i})`;
            html += `<div class="dot ${isActive ? 'active' : ''}" onclick="${clickFn}; event.stopPropagation();"></div>`;
        }
        return html;
    }

    // 切换点击模式
    function toggleClickMode() {
        isFastMode = !isFastMode;
        const btn = document.getElementById('modeBtn');
        btn.innerText = isFastMode ? "模式: 单击装备" : "模式: 双击装备";
        renderList();
    }

    // 切换排序模式
    function toggleSortMode() {
        cardSortMode = cardSortMode === 'type' ? 'cost' : 'type';
        const btn = document.getElementById('sortBtn');
        btn.innerText = cardSortMode === 'type' ? "排序: 按类别" : "排序: 按费用";
        renderList();
    }
    
    // 获取费用颜色
    function getCostColor(c) {
        if(c===1) return '#2ecc71';
        if(c===2) return '#3498db';
        if(c===3) return '#9b59b6';
        if(c===4) return '#e67e22';
        return '#e74c3c'; 
    }

    function handleFastClick(id) {
        showDetail(id);
        toggleCard(id);
    }

function renderList() {
        const container = document.getElementById('cardList');
        
        let displayList = [...DB];
        
        // 排序逻辑 (保持不变)
        displayList.sort((a, b) => {
            const typeMap = { human: 1, beast: 2, tool: 3 };
            if (cardSortMode === 'type') {
                if (typeMap[a.type] !== typeMap[b.type]) return typeMap[a.type] - typeMap[b.type];
                return a.cost - b.cost;
            } else {
                if (a.cost !== b.cost) return a.cost - b.cost;
                return typeMap[a.type] - typeMap[b.type];
            }
        });

        container.innerHTML = displayList.map(c => {
            const eventStr = isFastMode 
                ? `onclick="handleFastClick('${c.id}')"` 
                : `onclick="showDetail('${c.id}')" ondblclick="toggleCard('${c.id}')"`;

            return `
            <div class="card-item ${state[c.id].equipped ? 'equipped' : ''} ${currDetail === c.id ? 'active-detail' : ''}" id="row-${c.id}" ${eventStr}>
                
                <div class="card-meta">
                    <span class="card-type type-${c.type}">${c.type==='human'?'人':c.type==='beast'?'兽':'器'}</span>
                    <span class="card-name">${c.name}</span>
                    <span class="card-cost">${c.cost}C</span>
                </div>
                
                <div class="dots-wrapper">
                    ${makeDots(c.id, state[c.id].level)}
                </div>
            </div>
        `}).join('');
        
        document.getElementById('global-dots').innerHTML = makeDots('global', globalLvState, true);
        
        calc();
    }
    function toggleCard(id) {
        state[id].equipped = !state[id].equipped; 
        renderList();
    }

    function setLevel(id, lv) {
        if (state[id].level === lv) {
            state[id].level = 0; 
        } else {
            state[id].level = lv;
        }
        renderList();
        if (currDetail === id) showDetail(id);
    }

    function setGlobalLevel(lv) {
        if (globalLvState === lv) lv = 0;
        globalLvState = lv;
        DB.forEach(c => state[c.id].level = lv);
        renderList();
        if (currDetail) showDetail(currDetail);
    }

    function clearAll() {
        DB.forEach(c => state[c.id].equipped = false);
        renderList();
    }

    function toggleSort() {
        dpsSortDir = dpsSortDir === 'desc' ? 'asc' : 'desc';
        calc();
    }

    function toggleFreqMode() {
        freqMode = freqMode === 'interval' ? 'rate' : 'interval';
        document.getElementById('header-freq-text').innerText = freqMode === 'interval' ? '触发间隔' : '触发频率';
        calc();
    }

    let currDetail = null;
    function showDetail(id) {
        currDetail = id;
        renderList(); 
        
        const c = DB.find(x => x.id === id);
        let val = getStatVal(id);
        
        // 格式化辅助函数：保留2位精度，但去除末尾无用的0
        const fmt = (n) => parseFloat(n.toFixed(2));
        
        let desc = c.desc;
        if (id === 'linfeng') {
            const iceChance = 70 + ((100-70)/6 * state[id].level);
            desc = desc.replace('{val}', `<span class="highlight">${fmt(val)}</span>`)
                        .replace('{ice}', `<span class="highlight">${fmt(iceChance)}</span>`);
        } else {
            const displayVal = fmt(val);
            desc = desc.replace('{val}', `<span class="highlight">${displayVal}</span>`)
                        .replace('{freq}', `<span class="highlight">${displayVal}</span>`);
        }

        document.getElementById('detail-content').innerHTML = `
            <div class="detail-title">${c.name} <span style="font-size:12px; color:#999; font-weight:normal;">(Lv.${state[id].level})</span></div>
            <div class="detail-desc">${desc}</div>
        `;
    }

    renderList();
</script>

</body>
</html>